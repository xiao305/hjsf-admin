<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>红姐私房美食 - 管理员控制台</title>
    <base href="https://hjsf.uno/"> <!-- 添加 base 标签 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
/* 优化后的样式系统 */
:root {
    --primary: #e4393c;
    --secondary: #FFF0F0;
    --accent: #FFD700;
    --dark: #333;
    --light: #f8f9fa;
    --gray: #6c757d;
    --shadow: 0 4px 12px rgba(0,0,0,0.1);
}

* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: "PingFang SC", "Microsoft YaHei", sans-serif;
    line-height: 1.6;
    color: var(--dark);
    background-color: var(--light);
}

.container {
    width: 90%;
    max-width: 1200px;
    margin: 0 auto;
    padding: 0 15px;
}

/* 导航栏样式 */
.navbar {
    background: white;
    box-shadow: var(--shadow);
    position: sticky;
    top: 0;
    z-index: 100;
}

.navbar .container {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 15px 0;
}

.logo h2 {
    color: var(--primary);
    font-size: 1.5rem;
}

.nav-links {
    display: flex;
    gap: 20px;
}

.nav-links a {
    text-decoration: none;
    color: var(--dark);
    font-weight: 500;
    padding: 8px 12px;
    border-radius: 6px;
    transition: all 0.3s;
    display: flex;
    align-items: center;
    gap: 8px;
}

.nav-links a:hover {
    background-color: var(--primary);
    color: white;
}

/* 主要内容区域 */
.content-container {
    padding: 40px 0;
}

.page-header {
    text-align: center;
    margin-bottom: 40px;
}

.page-header h1 {
    color: var(--primary);
    margin-bottom: 15px;
}

.page-header p {
    color: var(--gray);
    font-size: 1.1rem;
}

/* 登录区域 */
.login-container {
    background: white;
    padding: 40px;
    border-radius: 12px;
    box-shadow: var(--shadow);
    max-width: 500px;
    margin: 40px auto;
    text-align: center;
}

.login-container h2 {
    margin-bottom: 30px;
    color: var(--dark);
}

.form-group {
    margin-bottom: 20px;
    text-align: left;
}

.form-group label {
    display: block;
    margin-bottom: 8px;
    font-weight: 500;
    color: var(--dark);
}

.form-group input {
    width: 100%;
    padding: 12px 15px;
    border: 1px solid #ddd;
    border-radius: 8px;
    font-size: 1rem;
}

/* 管理员面板 */
.admin-panel {
    background: white;
    border-radius: 12px;
    padding: 30px;
    box-shadow: var(--shadow);
}

.admin-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 30px;
    flex-wrap: wrap;
    gap: 20px;
}

.admin-header h2 {
    color: var(--primary);
}

/* 管理员功能增强 */
.admin-stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.stat-card {
    background: white;
    border-radius: 12px;
    padding: 20px;
    box-shadow: var(--shadow);
    text-align: center;
    border-top: 4px solid var(--primary);
    transition: all 0.3s;
}

.stat-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 20px rgba(0,0,0,0.15);
}

.stat-value {
    font-size: 2rem;
    font-weight: bold;
    color: var(--primary);
    margin: 10px 0;
}

.stat-label {
    color: var(--gray);
    font-size: 0.9rem;
}

/* 管理员设置区域 */
.admin-settings {
    background: var(--secondary);
    border-radius: 12px;
    padding: 25px;
    margin-bottom: 30px;
}

.settings-section {
    margin-bottom: 30px;
    padding-bottom: 20px;
    border-bottom: 1px solid rgba(0,0,0,0.1);
}

.settings-section h3 {
    margin-bottom: 20px;
    color: var(--dark);
    display: flex;
    align-items: center;
    gap: 10px;
}

.page-setting {
    background: white;
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 20px;
    box-shadow: var(--shadow);
}

.page-setting h4 {
    margin: 0 0 20px 0;
    color: var(--dark);
    display: flex;
    align-items: center;
    gap: 10px;
}

.setting-row {
    display: flex;
    align-items: center;
    gap: 15px;
    margin-bottom: 15px;
    flex-wrap: wrap;
}

.setting-row label {
    min-width: 80px;
    font-weight: 500;
    color: var(--dark);
}

.setting-row select,
.setting-row input {
    padding: 10px 15px;
    border: 1px solid #ddd;
    border-radius: 8px;
    font-size: 1rem;
    flex: 1;
    min-width: 150px;
}

.current-status {
    margin-top: 10px;
    padding: 10px 15px;
    background: var(--light);
    border-radius: 8px;
    font-size: 0.9rem;
    color: var(--gray);
}

/* 管理员列表样式 */
.admin-list {
    margin-top: 20px;
}

.admin-list table {
    width: 100%;
    border-collapse: collapse;
}

.admin-list th,
.admin-list td {
    padding: 12px 15px;
    text-align: left;
    border-bottom: 1px solid #eee;
}

.admin-list th {
    background-color: #f1f1f1;
    font-weight: 500;
}

.admin-list tr:hover {
    background-color: #f9f9f9;
}

/* 管理员密码列样式 */
.password-cell {
    display: flex;
    align-items: center;
    gap: 8px;
}

.password-display {
    flex: 1;
    padding: 6px 10px;
    border: 1px solid #ddd;
    border-radius: 4px;
    background-color: #f8f9fa;
    font-family: monospace;
    font-size: 0.9rem;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

.toggle-password-btn {
    background: none;
    border: 1px solid #ccc;
    border-radius: 4px;
    padding: 6px 8px;
    cursor: pointer;
    font-size: 0.9rem;
    transition: background-color 0.2s;
}

.toggle-password-btn:hover {
    background-color: #e9ecef;
}

/* 管理员操作按钮 */
.admin-actions {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
}

.action-btn {
    padding: 8px 15px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-size: 0.9rem;
    display: inline-flex;
    align-items: center;
    gap: 5px;
    transition: all 0.3s;
}

.delete-btn {
    background-color: #dc3545;
    color: white;
}

.delete-btn:hover {
    background-color: #c82333;
}

/* 留言管理样式 */
.messages-container {
    background: white;
    border-radius: 12px;
    padding: 25px;
    margin-top: 30px;
    box-shadow: var(--shadow);
}

.message-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
}

.message-stats {
    display: flex;
    gap: 20px;
}

.message-stats span {
    font-weight: 500;
    color: var(--dark);
}

.message-table {
    width: 100%;
    border-collapse: collapse;
}

.message-table th,
.message-table td {
    padding: 12px 15px;
    text-align: left;
    border-bottom: 1px solid #eee;
}

.message-table th {
    background-color: #f1f1f1;
    font-weight: 500;
}

.message-table tr:hover {
    background-color: #f9f9f9;
}

.message-actions {
    display: flex;
    gap: 10px;
}

/* 操作日志样式 */
.logs-container {
    background: white;
    border-radius: 12px;
    padding: 25px;
    margin-top: 30px;
    box-shadow: var(--shadow);
}

.log-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 15px;
    border-bottom: 1px solid #eee;
    transition: background-color 0.3s;
}

.log-item:hover {
    background-color: #f9f9f9;
}

.log-action {
    font-weight: 500;
    color: var(--primary);
}

.log-details {
    color: var(--gray);
    margin: 0 15px;
    flex: 1;
}

.log-time {
    color: var(--gray);
    font-size: 0.9rem;
}

/* 流量图样式 */
.traffic-chart {
    height: 200px;
    background: var(--light);
    border-radius: 8px;
    margin-top: 20px;
    display: flex;
    align-items: flex-end;
    gap: 5px;
    padding: 10px;
    box-sizing: border-box;
}

.traffic-bar {
    flex: 1;
    background: var(--primary);
    border-radius: 4px 4px 0 0;
    min-width: 20px;
    transition: height 0.5s;
}

/* 响应式设计 */
@media (max-width: 768px) {
    .navbar .container {
        flex-direction: column;
        gap: 15px;
    }
    
    .nav-links {
        flex-wrap: wrap;
        justify-content: center;
    }
    
    .admin-header {
        flex-direction: column;
        align-items: flex-start;
    }
    
    .admin-stats {
        grid-template-columns: 1fr 1fr;
    }
    
    .setting-row {
        flex-direction: column;
        align-items: flex-start;
    }
    
    .setting-row label {
        min-width: auto;
    }
    
    .setting-row select,
    .setting-row input {
        width: 100%;
    }
    
    .message-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 15px;
    }
    
    .log-item {
        flex-direction: column;
        align-items: flex-start;
        gap: 10px;
    }
    
    .log-details {
        margin: 5px 0;
    }
    
    .traffic-chart {
        height: 150px;
    }
}

/* 状态标签样式 */
.status-tag-open {
    background-color: #d4edda;
    color: #155724;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 0.8rem;
    font-weight: 500;
}

.status-tag-limit {
    background-color: #fff3cd;
    color: #856404;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 0.8rem;
    font-weight: 500;
}

.status-tag-closed {
    background-color: #f8d7da;
    color: #721c24;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 0.8rem;
    font-weight: 500;
}

/* 添加管理员表单 */
.add-admin-form {
    background: white;
    border-radius: 12px;
    padding: 20px;
    margin-top: 20px;
    box-shadow: var(--shadow);
}

.add-admin-form h4 {
    margin: 0 0 15px 0;
    color: var(--dark);
}

.form-row {
    display: flex;
    gap: 15px;
    margin-bottom: 15px;
    flex-wrap: wrap;
}

.form-row input {
    flex: 1;
    min-width: 200px;
    padding: 10px 15px;
    border: 1px solid #ddd;
    border-radius: 8px;
    font-size: 1rem;
}

.form-row button {
    padding: 10px 20px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-size: 1rem;
    font-weight: 500;
    transition: all 0.3s;
    background-color: var(--primary);
    color: white;
}

.form-row button:hover {
    background-color: #d32f2f;
}
    </style>
</head>
<body>
    <!-- 导航栏 -->
    <nav class="navbar">
        <div class="container">
            <div class="logo">
                <h2><i class="fas fa-user-shield"></i> 管理员控制台</h2>
            </div>
            <div class="nav-links">
                <!-- 修改为 https://hjsf.uno -->
                <a href="https://hjsf.uno"><i class="fas fa-home"></i> 返回首页</a>
                <a href="#" id="logoutBtn"><i class="fas fa-sign-out-alt"></i> 退出登录</a>
            </div>
        </div>
    </nav>

    <!-- 主要内容 -->
    <div class="container">
        <div class="page-header">
            <h1><i class="fas fa-user-shield"></i> 管理员控制台</h1>
            <p>欢迎使用红姐私房美食网站后台管理系统</p>
        </div>

        <!-- 登录区域 -->
        <div id="loginSection" class="login-container">
            <h2><i class="fas fa-sign-in-alt"></i> 管理员登录</h2>
            <form id="adminLogin">
                <div class="form-group">
                    <label for="username"><i class="fas fa-user"></i> 用户名</label>
                    <input type="text" id="username" required>
                </div>
                <div class="form-group">
                    <label for="password"><i class="fas fa-lock"></i> 密码</label>
                    <input type="password" id="password" required>
                </div>
                <button type="submit" class="btn"><i class="fas fa-sign-in-alt"></i> 登录</button>
            </form>
        </div>

        <!-- 管理员面板 (默认隐藏) -->
        <div id="adminPanel" class="admin-panel" style="display: none;">
            <div class="admin-header">
                <h2><i class="fas fa-tachometer-alt"></i> 仪表盘</h2>
                <div class="admin-stats">
                    <div class="stat-card">
                        <div class="stat-label">总访问量</div>
                        <div class="stat-value" id="totalVisits">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">今日访问</div>
                        <div class="stat-value" id="todayVisits">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">总留言数</div>
                        <div class="stat-value" id="totalMessagesHeader">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">未读留言</div>
                        <div class="stat-value" id="unreadMessages">0</div>
                    </div>
                </div>
            </div>

            <!-- 页面状态设置 -->
            <div class="admin-settings">
                <div class="settings-section">
                    <h3><i class="fas fa-cogs"></i> 页面状态管理</h3>
                    
                    <!-- 特产商城设置 -->
                    <div class="page-setting">
                        <h4><i class="fas fa-shopping-bag"></i> 特产商城</h4>
                        <div class="setting-row">
                            <label>状态:</label>
                            <select id="productsStatus">
                                <option value="open">开启</option>
                                <option value="limit">限制访问</option>
                                <option value="closed">关闭</option>
                            </select>
                            <!-- 优化1：调整了输入框宽度 -->
                            <input type="number" id="productsDuration" placeholder="限制秒数" min="1" style="width: 120px; display: none;">
                            <!-- 新增：关闭密码输入框 -->
                            <input type="text" id="productsPassword" placeholder="关闭密码" style="width: 120px; display: none;">
                            <button class="btn" onclick="applyPageStatus('products')"><i class="fas fa-save"></i> 应用</button>
                        </div>
                        <div class="current-status">当前状态: <span id="productsCurrentStatus">未知</span></div>
                    </div>

                    <!-- 关于我们设置 -->
                    <div class="page-setting">
                        <h4><i class="fas fa-info-circle"></i> 关于我们</h4>
                        <div class="setting-row">
                            <label>状态:</label>
                            <select id="aboutStatus">
                                <option value="open">开启</option>
                                <option value="limit">限制访问</option>
                                <option value="closed">关闭</option>
                            </select>
                            <!-- 优化1：调整了输入框宽度 -->
                            <input type="number" id="aboutDuration" placeholder="限制秒数" min="1" style="width: 120px; display: none;">
                            <!-- 新增：关闭密码输入框 -->
                            <input type="text" id="aboutPassword" placeholder="关闭密码" style="width: 120px; display: none;">
                            <button class="btn" onclick="applyPageStatus('about')"><i class="fas fa-save"></i> 应用</button>
                        </div>
                        <div class="current-status">当前状态: <span id="aboutCurrentStatus">未知</span></div>
                    </div>

                    <!-- 联系方式设置 -->
                    <div class="page-setting">
                        <h4><i class="fas fa-phone"></i> 联系方式</h4>
                        <div class="setting-row">
                            <label>状态:</label>
                            <select id="contactStatus">
                                <option value="open">开启</option>
                                <option value="limit">限制访问</option>
                                <option value="closed">关闭</option>
                            </select>
                            <!-- 优化1：调整了输入框宽度 -->
                            <input type="number" id="contactDuration" placeholder="限制秒数" min="1" style="width: 120px; display: none;">
                            <!-- 新增：关闭密码输入框 -->
                            <input type="text" id="contactPassword" placeholder="关闭密码" style="width: 120px; display: none;">
                            <button class="btn" onclick="applyPageStatus('contact')"><i class="fas fa-save"></i> 应用</button>
                        </div>
                        <div class="current-status">当前状态: <span id="contactCurrentStatus">未知</span></div>
                    </div>
                </div>

                <!-- 管理员管理 -->
                <div id="adminManagementSection" class="admin-settings">
                    <h3><i class="fas fa-users"></i> 管理员管理</h3>
                    
                    <!-- 创建新管理员 -->
                    <form id="addAdminForm" class="add-admin-form">
                        <h4>创建新管理员账号</h4>
                        <div class="form-row">
                            <input type="text" id="newAdminUsername" placeholder="输入新管理员用户名" required>
                            <button type="submit" class="btn"><i class="fas fa-plus"></i> 新增</button>
                        </div>
                        <p style="font-size: 0.9rem; color: var(--gray); margin-top: 10px;"><i class="fas fa-info-circle"></i> 新账号默认密码为 <strong>123456</strong>，创建后请及时修改密码。</p>
                    </form>

                    <!-- 管理员列表 -->
                    <div class="admin-list">
                        <h4 style="margin-top: 20px;">管理员列表</h4>
                        <table>
                            <thead>
                                <tr>
                                    <th>用户名</th>
                                    <!-- 优化2：新增密码列 -->
                                    <th>密码 (星号显示)</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody id="adminListBody">
                                <!-- 管理员列表将通过 JavaScript 动态加载 -->
                            </tbody>
                        </table>
                    </div>

                    <!-- 修改当前登录管理员密码 -->
                    <div class="settings-section">
                        <h3><i class="fas fa-key"></i> 修改密码</h3>
                        <form id="changePasswordForm" class="add-admin-form">
                            <div class="form-row">
                                <input type="password" id="oldPassword" placeholder="当前密码" required>
                                <input type="password" id="newPassword" placeholder="新密码" required>
                                <button type="submit" class="btn"><i class="fas fa-sync"></i> 修改</button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- 留言管理 -->
                <div class="messages-container">
                    <h3><i class="fas fa-comments"></i> 留言管理</h3>
                    <div class="message-header">
                        <div class="message-stats">
                            <span>总数: <span id="totalMessages">0</span></span>
                            <span>未读: <span id="unreadMessageCount">0</span></span>
                        </div>
                    </div>
                    <div id="messagesList">
                        <!-- 留言内容将通过JavaScript动态加载 -->
                    </div>
                </div>

                <!-- 访问日志 -->
                <div class="logs-container">
                    <h3><i class="fas fa-history"></i> 操作日志</h3>
                    <div id="logsList">
                        <!-- 日志内容将通过JavaScript动态加载 -->
                    </div>
                </div>

                <!-- 流量图 -->
                <div class="logs-container">
                    <h3><i class="fas fa-chart-line"></i> 近期访问流量</h3>
                    <div class="traffic-chart" id="trafficChart">
                        <!-- 流量图将通过JavaScript动态生成 -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 修改管理员密码的模态框 -->
    <div id="changeAdminPasswordModal" style="display:none; position: fixed; z-index: 1001; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.4); justify-content: center; align-items: center;">
        <div class="modal-content" style="background-color: white; margin: auto; padding: 20px; border-radius: 10px; width: 90%; max-width: 400px; box-shadow: 0 4px 8px rgba(0,0,0,0.2);">
            <span id="closeChangePasswordModal" style="float: right; cursor: pointer; font-size: 1.5rem;">&times;</span>
            <h3>修改管理员密码</h3>
            <p>为管理员 <strong><span id="changePasswordUsername"></span></strong> 修改密码</p>
            <form id="changeSpecificAdminPasswordForm">
                <div class="form-group">
                    <label for="newAdminPassword">新密码:</label>
                    <input type="password" id="newAdminPassword" class="form-control" required>
                </div>
                <button type="submit" class="btn"><i class="fas fa-sync"></i> 修改密码</button>
                <button type="button" id="cancelChangePassword" class="btn btn-outline" style="margin-left: 10px;">取消</button>
            </form>
        </div>
    </div>

    <script>
// 全局变量
let isAdminLoggedIn = false;
let currentAdminUser = null; // 记录当前登录的管理员用户名
// 修复：使用 Base64 编码存储密码
let adminAccounts = JSON.parse(localStorage.getItem('adminAccounts'))|| {'admin': btoa('hongjie123')}; // 默认账号 admin:hongjie123 (Base64)
let messages = JSON.parse(localStorage.getItem('messages'))|| [];
let logs = JSON.parse(localStorage.getItem('adminLogs'))|| [];
let visits = JSON.parse(localStorage.getItem('siteVisits'))|| { total: 0, daily: {} };

// 页面加载完成后初始化
document.addEventListener('DOMContentLoaded', function() {
    console.log("🔧 页面加载完成，开始初始化...");
    
    // 初始化设置面板 UI
    initializeSettingsPanel();
    
    console.log("✅ 页面加载和配置初始化完成");
});

// 管理员登录
document.getElementById('adminLogin').addEventListener('submit', function(e) {
    e.preventDefault(); // 关键：绝对阻止表单默认提交和页面刷新
    
    const username = document.getElementById('username').value.trim();
    const password = document.getElementById('password').value;
    
    // - 关键修改：优先使用从 OSS 加载的全局 adminAccounts，回退到局部变量 -
    // 这确保了新设备在加载完 OSS 配置后，能使用其中的账号信息进行登录
    const accountsToUse = window.adminAccounts|| adminAccounts;
    
    console.log("登录验证时使用的账号列表 (accountsToUse):", accountsToUse); // 调试日志，可以查看
    
    const storedHash = accountsToUse[username];
    
    // - 结束关键修改 -
    if(storedHash && storedHash === btoa(password)) { // 使用 Base64 解码比较
        isAdminLoggedIn = true;
        currentAdminUser = username; // 记录当前用户
        
        document.getElementById('loginSection').style.display = 'none';
        document.getElementById('adminPanel').style.display = 'block';
        
        // 记录登录日志
        addLog('管理员登录', `管理员 ${username} 登录系统`);
        console.log(`管理员 ${username} 登录成功`);
        alert(`欢迎，${username}！`);
        
        // - 新增：登录成功后，从 OSS 加载最新的配置和数据并更新 UI -
        loadConfigFromOSSAndInitializeSettingsPanel().then(() => {
            console.log('✅ 登录后成功从 OSS 加载配置并初始化 UI');
        }).catch((error) => {
            console.error('❌ 登录后从 OSS 加载配置并初始化 UI 失败:', error);
            // 即使加载失败，也使用本地默认值初始化
            // initializeSettingsPanel(); // initializeSettingsPanel 已在 loadConfigFromOSSAndInitializeSettingsPanel 内部或其失败回调中被调用
        });
    } else {
        alert('管理员账号或密码错误！'); // 保持一致的提示
        console.log(`管理员 ${username} 登录失败：账号或密码错误`);
        // 可选：打印一下当前使用的账号列表，方便调试
        console.log("当前用于验证的账号列表 (accountsToUse):", accountsToUse);
    }
});

// 退出登录
document.getElementById('logoutBtn').addEventListener('click', function() {
    isAdminLoggedIn = false;
    currentAdminUser = null; // 清除当前用户记录
    
    document.getElementById('loginSection').style.display = 'block';
    document.getElementById('adminPanel').style.display = 'none';
    
    // 修复：重置登录表单
    document.getElementById('adminLogin').reset(); // 使用正确的表单ID
    
    addLog('退出登录', '管理员退出了系统');
});

// 初始化设置面板 UI
function initializeSettingsPanel() {
    console.log("🔧 开始初始化设置面板 UI...");
    
    // 修复：优先使用从 OSS 加载的全局配置
    const config = window.pageStatusConfig|| pageStatusConfig;
    const passwords = window.pagePasswords|| pagePasswords;
    
    // 修复：优先使用从 OSS 加载的全局管理员账号
    const accounts = window.adminAccounts|| adminAccounts;
    
    // 初始化页面状态设置
    Object.keys(config).forEach(pageId => {
        const pageConfig = config[pageId];
        const statusSelect = document.getElementById(`${pageId}Status`);
        const durationInput = document.getElementById(`${pageId}Duration`);
        const passwordInputForClosed = document.getElementById(`${pageId}Password`);
        
        if (statusSelect) {
            statusSelect.value = pageConfig.status || 'closed';
            
            if (pageConfig.duration) {
                durationInput.value = pageConfig.duration;
                durationInput.style.display = 'inline-block';
            } else {
                durationInput.style.display = 'none';
            }
            
            if (passwordInputForClosed) {
                passwordInputForClosed.value = passwords[pageId] || '';
                passwordInputForClosed.style.display = (pageConfig.status === 'closed') ? 'inline-block' : 'none';
            }
            
            updateCurrentStatusDisplay(pageId);
        }
    });
    
    // 初始化管理员列表
    if (document.getElementById('adminListBody')) {
        loadAdminList();
    }
    
    // 更新统计信息
    updateStats();
    loadMessages();
    loadLogs();
    drawTrafficChart();
    
    console.log("🔧 设置面板 UI 初始化完成");
}

// 加载并显示管理员列表 (包含密码显示功能)
function loadAdminList() {
    const accounts = window.adminAccounts|| adminAccounts;
    const listBody = document.getElementById('adminListBody');
    
    if (!listBody) return;
    
    listBody.innerHTML = ''; // 清空现有列表
    
    Object.keys(accounts).forEach(username => {
        const row = document.createElement('tr');
        
        // 创建密码显示单元格
        const passwordCell = document.createElement('td');
        passwordCell.className = 'password-cell';
        
        const passwordDisplay = document.createElement('span');
        passwordDisplay.className = 'password-display';
        passwordDisplay.textContent = '••••••';
        passwordDisplay.dataset.isMasked = 'true';
        
        const toggleButton = document.createElement('button');
        toggleButton.className = 'toggle-password-btn';
        toggleButton.innerHTML = '<i class="fas fa-eye"></i>';
        toggleButton.title = '显示密码';
        
        // 添加密码显示切换功能
        toggleButton.addEventListener('click', function() {
            if (passwordDisplay.dataset.isMasked === 'true') {
                // 当前是隐藏，点击后显示明文
                passwordDisplay.textContent = atob(accounts[username]); // Base64 解码
                passwordDisplay.dataset.isMasked = 'false';
                toggleButton.innerHTML = '<i class="fas fa-eye-slash"></i>';
                toggleButton.title = '隐藏密码';
            } else {
                // 当前是明文，点击后显示星号
                passwordDisplay.textContent = '••••••';
                passwordDisplay.dataset.isMasked = 'true';
                toggleButton.innerHTML = '<i class="fas fa-eye"></i>';
                toggleButton.title = '显示密码';
            }
        });
        
        passwordCell.appendChild(passwordDisplay);
        passwordCell.appendChild(toggleButton);
        
        // 创建操作单元格
        const actionsCell = document.createElement('td');
        actionsCell.className = 'admin-actions';
        actionsCell.innerHTML = `
            <button class="action-btn" onclick="showChangePasswordModal('${username}')">
                <i class="fas fa-key"></i> 修改密码
            </button>
            ${username !== 'admin' ? 
                `<button class="action-btn delete-btn" onclick="deleteAdmin('${username}')">
                    <i class="fas fa-trash"></i> 删除
                </button>` : 
                '<span style="color: var(--gray); font-size: 0.85rem;">(主账号)</span>'
            }
        `;
        
        // 构建行内容
        row.innerHTML = `
            <td>${username}</td>
            <td></td> <!-- 占位，稍后替换 -->
            <td class="admin-actions"></td>
        `;
        
        // 将密码单元格插入到正确的位置
        row.children[1].appendChild(passwordCell);
        // 将操作单元格插入到正确的位置
        row.children[2].innerHTML = actionsCell.innerHTML;
        
        listBody.appendChild(row);
    });
}

// 显示修改特定管理员密码的模态框
let targetAdminForPasswordChange = null; // 全局变量，记录要修改密码的管理员用户名

function showChangePasswordModal(username) {
    targetAdminForPasswordChange = username;
    document.getElementById('changePasswordUsername').textContent = username;
    document.getElementById('newAdminPassword').value = ''; // 清空输入框
    document.getElementById('changeAdminPasswordModal').style.display = 'flex';
}

// 关闭模态框
document.getElementById('closeChangePasswordModal').addEventListener('click', () => {
    document.getElementById('changeAdminPasswordModal').style.display = 'none';
});

document.getElementById('cancelChangePassword').addEventListener('click', () => {
    document.getElementById('changeAdminPasswordModal').style.display = 'none';
});

// 点击模态框外部区域关闭
window.addEventListener('click', (event) => {
    const modal = document.getElementById('changeAdminPasswordModal');
    if (event.target === modal) {
        modal.style.display = 'none';
    }
});

// 修改特定管理员密码
document.getElementById('changeSpecificAdminPasswordForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    if (!isAdminLoggedIn|| !targetAdminForPasswordChange) return;
    
    const newPassword = document.getElementById('newAdminPassword').value.trim();
    
    if (!newPassword) {
        alert('请输入新密码！');
        return;
    }
    
    // 更新内存中的密码
    const accounts = window.adminAccounts|| adminAccounts;
    accounts[targetAdminForPasswordChange] = btoa(newPassword); // Base64 编码
    
    // 同步到 localStorage
    localStorage.setItem('adminAccounts', JSON.stringify(accounts));
    
    // 同步到全局变量 (如果 window.adminAccounts 存在)
    if (window.adminAccounts) {
        window.adminAccounts = accounts;
    }
    
    // 记录日志
    addLog('修改管理员密码', `管理员 ${currentAdminUser} 修改了 ${targetAdminForPasswordChange} 的密码`);
    
    alert(`管理员 "${targetAdminForPasswordChange}" 的密码已修改！`);
    
    document.getElementById('changeAdminPasswordModal').style.display = 'none';
    
    // 同步到云端
    const configToSync = {
        pageStatusConfig: window.pageStatusConfig|| pageStatusConfig,
        pagePasswords: window.pagePasswords|| pagePasswords,
        adminAccounts: window.adminAccounts|| adminAccounts,
        messages: messages,
        adminLogs: logs,
        siteVisits: visits,
        timestamp: new Date().toISOString()
    };
    
    syncConfigToFC(configToSync).then(() => {
        console.log('Aliyun FC Sync: 修改管理员密码后，配置已同步');
        loadAdminList(); // 重新加载列表以反映变化
    }).catch((error) => {
        console.error('Aliyun FC Sync: 修改管理员密码后，同步配置失败:', error);
        addLog('修改管理员密码', `管理员 ${currentAdminUser} 修改了 ${targetAdminForPasswordChange} 的密码 (本地修改成功，远程同步到阿里云 FC 失败: ${error.message})`);
        alert(`密码已修改(本地)，但同步到云端时出错: ${error.message}`);
        loadAdminList(); // 即使同步失败，也重新加载列表
    });
});

// 删除管理员
function deleteAdmin(username) {
    if (!isAdminLoggedIn|| username === 'admin') return; // 禁止删除主账号
    
    if (!confirm(`确定要删除管理员账号 "${username}" 吗？此操作不可撤销。`)) {
        return;
    }
    
    // 更新内存中的账号列表
    const accounts = window.adminAccounts|| adminAccounts;
    delete accounts[username];
    
    // 同步到 localStorage
    localStorage.setItem('adminAccounts', JSON.stringify(accounts));
    
    // 同步到全局变量 (如果 window.adminAccounts 存在)
    if (window.adminAccounts) {
        window.adminAccounts = accounts;
    }
    
    // 记录日志
    addLog('删除管理员', `管理员 ${currentAdminUser} 删除了管理员账号: ${username}`);
    
    alert(`管理员账号 "${username}" 已删除！`);
    
    // 同步到云端
    const configToSync = {
        pageStatusConfig: window.pageStatusConfig|| pageStatusConfig,
        pagePasswords: window.pagePasswords|| pagePasswords,
        adminAccounts: window.adminAccounts|| adminAccounts,
        messages: messages,
        adminLogs: logs,
        siteVisits: visits,
        timestamp: new Date().toISOString()
    };
    
    syncConfigToFC(configToSync).then(() => {
        console.log('Aliyun FC Sync: 删除管理员后，配置已同步');
        loadAdminList(); // 重新加载列表
    }).catch((error) => {
        console.error('Aliyun FC Sync: 删除管理员后，同步配置失败:', error);
        addLog('删除管理员', `管理员 ${currentAdminUser} 删除了管理员账号: ${username} (本地删除成功，远程同步到阿里云 FC 失败: ${error.message})`);
        alert(`账号已删除(本地)，但同步到云端时出错: ${error.message}`);
        loadAdminList(); // 即使同步失败，也重新加载列表
    });
}

// 创建新管理员账号
document.getElementById('addAdminForm').addEventListener('submit', function(e) {
    e.preventDefault(); // 阻止表单默认提交刷新页面
    
    if (!isAdminLoggedIn) {
        alert('请先登录！');
        return;
    }
    
    // 新增：权限检查
    if (currentAdminUser !== 'admin') {
        alert('只有主管理员 (admin) 可以创建新管理员账号！');
        return;
    }
    
    const newUsername = document.getElementById('newAdminUsername').value.trim();
    
    if (!newUsername) {
        alert('请输入新管理员账号！');
        return;
    }
    
    // 修复：检查全局变量 window.adminAccounts
    const currentAdminAccounts = window.adminAccounts|| adminAccounts;
    
    if (currentAdminAccounts[newUsername]) {
        alert('该管理员账号已存在！');
        return;
    }
    
    // 添加新账号，默认密码 '123456'
    const defaultPassword = '123456';
    
    // 修复：更新全局变量和 localStorage
    if (window.adminAccounts) {
        window.adminAccounts[newUsername] = btoa(defaultPassword); // 更新全局变量
    }
    adminAccounts[newUsername] = btoa(defaultPassword); // 更新局部变量（保险）
    localStorage.setItem('adminAccounts', JSON.stringify(adminAccounts)); // 保存到 localStorage
    
    // 记录日志
    addLog('新增管理员', `管理员 ${currentAdminUser} 新增了管理员账号: ${newUsername} (默认密码: ${defaultPassword})`);
    
    // 准备要同步到阿里云 FC 的完整数据结构
    const configToSync = {
        pageStatusConfig: window.pageStatusConfig|| pageStatusConfig,
        pagePasswords: window.pagePasswords|| pagePasswords,
        adminAccounts: window.adminAccounts|| adminAccounts, // 优先使用全局（包含新账号）
        messages: messages,
        adminLogs: logs,
        siteVisits: visits,
        timestamp: new Date().toISOString()
    };
    
    // 调用同步函数
    syncConfigToFC(configToSync).then(() => {
        console.log('Aliyun FC Sync: 新增管理员后，配置已同步');
        
        // 清空表单
        document.getElementById('addAdminForm').reset();
        
        alert(`管理员账号 "${newUsername}" 创建成功并已同步！默认密码为 '${defaultPassword}'，请及时修改。`);
        
        // 重新加载管理员列表
        loadAdminList();
    }).catch((error) => {
        console.error('Aliyun FC Sync: 新增管理员后，同步配置失败:', error);
        
        // 即使同步失败，本地设置已生效，可以提示用户
        addLog('新增管理员', `管理员 ${currentAdminUser} 新增了管理员账号: ${newUsername} (本地添加成功，远程同步到阿里云 FC 失败: ${error.message})`);
        
        // 清空表单
        document.getElementById('addAdminForm').reset();
        
        alert(`管理员账号 "${newUsername}" 已创建(本地)，但同步到云端时出错: ${error.message}。请稍后手动同步或检查网络。`);
        
        // 即使同步失败，也重新加载管理员列表
        loadAdminList();
    });
});

// 修改密码
document.getElementById('changePasswordForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    if (!isAdminLoggedIn) {
        alert('请先登录！');
        return;
    }
    
    const oldPasswordInput = document.getElementById('oldPassword');
    const newPasswordInput = document.getElementById('newPassword');
    
    const oldPassword = oldPasswordInput.value;
    const newPassword = newPasswordInput.value;
    
    if (!oldPassword || !newPassword) {
        alert('请输入旧密码和新密码！');
        return;
    }
    
    // 验证旧密码
    const accounts = window.adminAccounts|| adminAccounts;
    
    if (accounts[currentAdminUser] !== btoa(oldPassword)) {
        alert('旧密码错误！');
        return;
    }
    
    // 更新密码
    accounts[currentAdminUser] = btoa(newPassword);
    
    // 同步到 localStorage
    localStorage.setItem('adminAccounts', JSON.stringify(accounts));
    
    // 同步到全局变量 (如果 window.adminAccounts 存在)
    if (window.adminAccounts) {
        window.adminAccounts = accounts;
    }
    
    // 记录日志
    addLog('修改密码', `管理员 ${currentAdminUser} 修改了自己的密码`);
    
    // 清空表单
    oldPasswordInput.value = '';
    newPasswordInput.value = '';
    
    alert('密码修改成功！');
    
    // 修改密码后也同步所有配置
    const configToSync = {
        pageStatusConfig: window.pageStatusConfig|| pageStatusConfig,
        pagePasswords: window.pagePasswords|| pagePasswords,
        adminAccounts: window.adminAccounts|| adminAccounts,
        messages: messages,
        adminLogs: logs,
        siteVisits: visits,
        timestamp: new Date().toISOString()
    };
    
    syncConfigToFC(configToSync).then(() => {
        console.log('Aliyun FC Sync: 修改密码后，配置已同步');
    }).catch((error) => {
        console.error('Aliyun FC Sync: 修改密码后，同步配置失败:', error);
        addLog('修改密码', `管理员 ${currentAdminUser} 修改了自己的密码 (本地修改成功，远程同步到阿里云 FC 失败: ${error.message})`);
        alert(`密码已修改(本地)，但同步到云端时出错: ${error.message}`);
    });
});

// 应用页面状态设置
function applyPageStatus(pageId) {
    const statusSelect = document.getElementById(`${pageId}Status`);
    const durationInput = document.getElementById(`${pageId}Duration`);
    const passwordInputForClosed = document.getElementById(`${pageId}Password`);
    const password = passwordInputForClosed?.value|| '';
    
    if (!statusSelect) return;
    
    const status = statusSelect.value;
    const duration = status === 'limit' ? parseInt(durationInput?.value)|| 10 : null;
    
    // 更新内存中的配置
    // 修复：优先使用从 OSS 加载的全局配置
    const config = window.pageStatusConfig|| pageStatusConfig;
    const passwords = window.pagePasswords|| pagePasswords;
    
    config[pageId] = config[pageId]|| {};
    config[pageId].status = status;
    
    if (duration !== null) {
        config[pageId].duration = duration;
    } else {
        delete config[pageId].duration;
    }
    
    // 始终更新密码
    passwords[pageId] = password;
    
    // 更新UI显示
    updateCurrentStatusDisplay(pageId);
    
    if (durationInput) {
        durationInput.style.display = (status === 'limit') ? 'inline-block' : 'none';
    }
    
    if(passwordInputForClosed) {
        passwordInputForClosed.style.display = (status === 'closed') ? 'inline-block' : 'none';
    }
    
    // 记录日志
    addLog('修改页面状态', `将页面 "${pageId}" 的状态修改为: ${status}${duration ? ` (${duration}秒)` : ''}${password ? ' (已设置密码)' : ''}`);
    
    // 准备要同步到阿里云 FC 的完整数据结构
    const configToSync = {
        pageStatusConfig: window.pageStatusConfig|| pageStatusConfig,
        pagePasswords: window.pagePasswords|| pagePasswords,
        adminAccounts: window.adminAccounts|| adminAccounts,
        messages: messages,
        adminLogs: logs,
        siteVisits: visits,
        timestamp: new Date().toISOString()
    };
    
    // 调用同步函数
    syncConfigToFC(configToSync).then(() => {
        console.log('Aliyun FC Sync: 页面状态修改后，配置已同步');
    }).catch((error) => {
        console.error('Aliyun FC Sync: 页面状态修改后，同步配置失败:', error);
        addLog('修改页面状态', `将页面 "${pageId}" 的状态修改为: ${status}${duration ? ` (${duration}秒)` : ''}${password ? ' (已设置密码)' : ''} (本地修改成功，远程同步到阿里云 FC 失败: ${error.message})`);
    });
}

// 更新当前状态显示
function updateCurrentStatusDisplay(pageId) {
    // 修复：优先使用从 OSS 加载的全局配置
    const config = window.pageStatusConfig|| pageStatusConfig;
    const status = config[pageId]?.status|| 'closed';
    const duration = config[pageId]?.duration;
    const currentStatusTextElement = document.getElementById(`${pageId}CurrentStatus`);
    let statusText = '';
    let statusClass = '';
    
    switch(status) {
        case 'open':
            statusText = '开启';
            statusClass = 'status-tag-open';
            break;
        case 'limit':
            statusText = `限制 (${duration|| 10}秒)`;
            statusClass = 'status-tag-limit';
            break;
        case 'closed':
            statusText = '关闭';
            statusClass = 'status-tag-closed';
            break;
        default:
            statusText = '未知';
            statusClass = 'status-tag-default';
    }
    
    if (currentStatusTextElement) {
        currentStatusTextElement.textContent = statusText;
        currentStatusTextElement.className = statusClass;
    }
}

// 更新统计信息
function updateStats() {
    document.getElementById('totalVisits').textContent = visits.total|| 0;
    document.getElementById('totalMessagesHeader').textContent = messages.length|| 0;
    
    const unreadCount = messages.filter(msg => !msg.read).length;
    document.getElementById('unreadMessages').textContent = unreadCount;
    document.getElementById('totalMessages').textContent = messages.length|| 0;
    document.getElementById('unreadMessageCount').textContent = unreadCount;
}

// 加载留言
function loadMessages() {
    const messagesList = document.getElementById('messagesList');
    if (!messagesList) return;
    
    // 清空现有留言
    messagesList.innerHTML = '';
    
    // 反向排序（最新的在前面）
    const sortedMessages = [...messages].reverse();
    
    sortedMessages.forEach((msg, index) => {
        const row = document.createElement('div');
        row.className = 'message-row';
        row.innerHTML = `
            <div class="message-content">
                <div class="message-header">
                    <strong>${msg.name}</strong>
                    <span>${msg.timestamp}</span>
                </div>
                <div class="message-body">
                    <p>${msg.message}</p>
                </div>
                <div class="message-footer">
                    <small>电话: ${msg.phone}</small>
                </div>
            </div>
            <div class="message-actions">
                <button class="action-btn delete-btn" data-index="${messages.length - 1 - index}">
                    <i class="fas fa-trash"></i>
                </button>
                <button class="action-btn export-btn" data-index="${messages.length - 1 - index}">
                    <i class="fas fa-download"></i>
                </button>
            </div>
        `;
        
        messagesList.appendChild(row);
        
        // 添加删除功能
        row.querySelector('.delete-btn').addEventListener('click', function() {
            const index = messages.length - 1 - parseInt(this.getAttribute('data-index'));
            if(confirm('确定要删除这条留言吗？')) {
                // 记录删除日志
                addLog('删除留言', `管理员 ${currentAdminUser} 删除了 ${messages[index].name} 的留言`);
                messages.splice(index, 1);
                localStorage.setItem('messages', JSON.stringify(messages));
                loadMessages(); // 重新加载
            }
        });
        
        // 添加导出功能
        row.querySelector('.export-btn').addEventListener('click', function() {
            const index = messages.length - 1 - parseInt(this.getAttribute('data-index'));
            const message = messages[index];
            const content = `姓名: ${message.name}\n电话: ${message.phone}\n留言: ${message.message}\n时间: ${message.timestamp}`;
            const blob = new Blob([content], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `留言-${message.name}-${message.timestamp}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        });
    });
}

// 加载操作日志
function loadLogs() {
    const logsList = document.getElementById('logsList');
    if (!logsList) return;
    
    // 清空现有日志
    logsList.innerHTML = '';
    
    // 反向排序（最新的在前面）
    [ ...logs ].reverse().forEach(log => {
        const logItem = document.createElement('div');
        logItem.className = 'log-item';
        logItem.innerHTML = `
            <div>
                <span class="log-action">${log.action}</span>
                <span class="log-details">${log.details}</span>
            </div>
            <div class="log-time">${log.timestamp}</div>
        `;
        logsList.appendChild(logItem);
    });
}

// 绘制流量图
function drawTrafficChart() {
    const chartContainer = document.getElementById('trafficChart');
    if (!chartContainer) return;
    
    // 获取最近7天的数据
    const dates = [];
    const values = [];
    
    for (let i = 6; i >= 0; i--) {
        const date = new Date();
        date.setDate(date.getDate() - i);
        const dateStr = date.toLocaleDateString();
        dates.push(dateStr);
        
        const value = visits.daily[dateStr] || 0;
        values.push(value);
    }
    
    // 清空图表容器
    chartContainer.innerHTML = '';
    
    // 计算最大值用于比例缩放
    const maxValue = Math.max(...values, 1);
    
    // 绘制柱状图
    values.forEach((value, index) => {
        const bar = document.createElement('div');
        bar.className = 'traffic-bar';
        bar.style.height = `${(value / maxValue) * 100}%`;
        bar.title = `${dates[index]}: ${value} 次访问`;
        chartContainer.appendChild(bar);
    });
}

// 添加操作日志
function addLog(action, details) {
    const timestamp = new Date().toLocaleString();
    logs.push({ action, details, timestamp });
    
    // 只保留最近100条日志
    if (logs.length > 100) {
        logs.shift();
    }
    
    localStorage.setItem('adminLogs', JSON.stringify(logs));
    loadLogs(); // 更新日志显示
}

// 同步配置到阿里云 FC
async function syncConfigToFC(config) {
    try {
        const response = await fetch('https://updatewteconfig-aquxgazwhl.cn-hangzhou.fcapp.run/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(config)
        });
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        return await response.json();
    } catch (error) {
        console.error('同步配置到阿里云 FC 失败:', error);
        throw error;
    }
}

// 从阿里云 OSS 加载配置并初始化设置面板
async function loadConfigFromOSSAndInitializeSettingsPanel() {
    try {
        const response = await fetch('https://xiao-config-bucket.oss-cn-hangzhou.aliyuncs.com/test-config.json');
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        
        if (data && data.pageStatusConfig) {
            console.log("✅ 成功从 OSS 读取到配置:", data);
            
            // 更新全局配置变量和密码变量以及管理员账号变量
            window.pageStatusConfig = data.pageStatusConfig;
            window.pagePasswords = data.pagePasswords|| {};
            window.adminAccounts = data.adminAccounts|| {}; // 新增：更新全局管理员账号变量
            window.messages = data.messages|| []; // 新增：更新全局留言变量
            window.logs = data.adminLogs|| []; // 新增：更新全局日志变量
            window.visits = data.siteVisits|| { total: 0, daily: {} }; // 新增：更新全局访问量变量
            
            console.log("🔄 已更新全局配置变量");
            
            // 初始化设置面板 UI
            initializeSettingsPanel();
        } else {
            console.log("OSS: 远程配置为空或格式不正确");
            // 回退到 localStorage
            initializeSettingsPanel();
        }
    } catch (fetchError) {
        console.error("❌ 从阿里云 OSS 加载配置失败:", fetchError);
        // 回退到 localStorage
        initializeSettingsPanel();
    }
}
    </script>
</body>
</html>
