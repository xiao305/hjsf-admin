<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>çº¢å§ç§æˆ¿ç¾é£Ÿ - ç®¡ç†å‘˜æ§åˆ¶å°</title>
    <base href="https://hjsf.uno/"> <!-- æ·»åŠ  base æ ‡ç­¾ -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
/* ä¼˜åŒ–åçš„æ ·å¼ç³»ç»Ÿ */
:root {
    --primary: #e4393c;
    --secondary: #FFF0F0;
    --accent: #FFD700;
    --dark: #333;
    --light: #f8f9fa;
    --gray: #6c757d;
    --shadow: 0 4px 12px rgba(0,0,0,0.1);
}

* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: "PingFang SC", "Microsoft YaHei", sans-serif;
    line-height: 1.6;
    color: var(--dark);
    background-color: var(--light);
}

.container {
    width: 90%;
    max-width: 1200px;
    margin: 0 auto;
    padding: 0 15px;
}

/* å¯¼èˆªæ æ ·å¼ */
.navbar {
    background: white;
    box-shadow: var(--shadow);
    position: sticky;
    top: 0;
    z-index: 100;
}

.navbar .container {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 15px 0;
}

.logo h2 {
    color: var(--primary);
    font-size: 1.5rem;
}

.nav-links {
    display: flex;
    gap: 20px;
}

.nav-links a {
    text-decoration: none;
    color: var(--dark);
    font-weight: 500;
    padding: 8px 12px;
    border-radius: 6px;
    transition: all 0.3s;
    display: flex;
    align-items: center;
    gap: 8px;
}

.nav-links a:hover {
    background-color: var(--primary);
    color: white;
}

/* ä¸»è¦å†…å®¹åŒºåŸŸ */
.content-container {
    padding: 40px 0;
}

.page-header {
    text-align: center;
    margin-bottom: 40px;
}

.page-header h1 {
    color: var(--primary);
    margin-bottom: 15px;
}

.page-header p {
    color: var(--gray);
    font-size: 1.1rem;
}

/* ç™»å½•åŒºåŸŸ */
.login-container {
    background: white;
    padding: 40px;
    border-radius: 12px;
    box-shadow: var(--shadow);
    max-width: 500px;
    margin: 40px auto;
    text-align: center;
}

.login-container h2 {
    margin-bottom: 30px;
    color: var(--dark);
}

.form-group {
    margin-bottom: 20px;
    text-align: left;
}

.form-group label {
    display: block;
    margin-bottom: 8px;
    font-weight: 500;
    color: var(--dark);
}

.form-group input {
    width: 100%;
    padding: 12px 15px;
    border: 1px solid #ddd;
    border-radius: 8px;
    font-size: 1rem;
}

/* ç®¡ç†å‘˜é¢æ¿ */
.admin-panel {
    background: white;
    border-radius: 12px;
    padding: 30px;
    box-shadow: var(--shadow);
}

.admin-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 30px;
    flex-wrap: wrap;
    gap: 20px;
}

.admin-header h2 {
    color: var(--primary);
}

/* ç®¡ç†å‘˜åŠŸèƒ½å¢å¼º */
.admin-stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.stat-card {
    background: white;
    border-radius: 12px;
    padding: 20px;
    box-shadow: var(--shadow);
    text-align: center;
    border-top: 4px solid var(--primary);
    transition: all 0.3s;
}

.stat-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 20px rgba(0,0,0,0.15);
}

.stat-value {
    font-size: 2rem;
    font-weight: bold;
    color: var(--primary);
    margin: 10px 0;
}

.stat-label {
    color: var(--gray);
    font-size: 0.9rem;
}

/* ç®¡ç†å‘˜è®¾ç½®åŒºåŸŸ */
.admin-settings {
    background: var(--secondary);
    border-radius: 12px;
    padding: 25px;
    margin-bottom: 30px;
}

.settings-section {
    margin-bottom: 30px;
    padding-bottom: 20px;
    border-bottom: 1px solid rgba(0,0,0,0.1);
}

.settings-section h3 {
    margin-bottom: 20px;
    color: var(--dark);
    display: flex;
    align-items: center;
    gap: 10px;
}

.page-setting {
    background: white;
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 20px;
    box-shadow: var(--shadow);
}

.page-setting h4 {
    margin: 0 0 20px 0;
    color: var(--dark);
    display: flex;
    align-items: center;
    gap: 10px;
}

.setting-row {
    display: flex;
    align-items: center;
    gap: 15px;
    margin-bottom: 15px;
    flex-wrap: wrap;
}

.setting-row label {
    min-width: 80px;
    font-weight: 500;
    color: var(--dark);
}

.setting-row select,
.setting-row input {
    padding: 10px 15px;
    border: 1px solid #ddd;
    border-radius: 8px;
    font-size: 1rem;
    flex: 1;
    min-width: 150px;
}

.current-status {
    margin-top: 10px;
    padding: 10px 15px;
    background: var(--light);
    border-radius: 8px;
    font-size: 0.9rem;
    color: var(--gray);
}

/* ç®¡ç†å‘˜åˆ—è¡¨æ ·å¼ */
.admin-list {
    margin-top: 20px;
}

.admin-list table {
    width: 100%;
    border-collapse: collapse;
}

.admin-list th,
.admin-list td {
    padding: 12px 15px;
    text-align: left;
    border-bottom: 1px solid #eee;
}

.admin-list th {
    background-color: #f1f1f1;
    font-weight: 500;
}

.admin-list tr:hover {
    background-color: #f9f9f9;
}

/* ç®¡ç†å‘˜å¯†ç åˆ—æ ·å¼ */
.password-cell {
    display: flex;
    align-items: center;
    gap: 8px;
}

.password-display {
    flex: 1;
    padding: 6px 10px;
    border: 1px solid #ddd;
    border-radius: 4px;
    background-color: #f8f9fa;
    font-family: monospace;
    font-size: 0.9rem;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

.toggle-password-btn {
    background: none;
    border: 1px solid #ccc;
    border-radius: 4px;
    padding: 6px 8px;
    cursor: pointer;
    font-size: 0.9rem;
    transition: background-color 0.2s;
}

.toggle-password-btn:hover {
    background-color: #e9ecef;
}

/* ç®¡ç†å‘˜æ“ä½œæŒ‰é’® */
.admin-actions {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
}

.action-btn {
    padding: 8px 15px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-size: 0.9rem;
    display: inline-flex;
    align-items: center;
    gap: 5px;
    transition: all 0.3s;
}

.delete-btn {
    background-color: #dc3545;
    color: white;
}

.delete-btn:hover {
    background-color: #c82333;
}

/* ç•™è¨€ç®¡ç†æ ·å¼ */
.messages-container {
    background: white;
    border-radius: 12px;
    padding: 25px;
    margin-top: 30px;
    box-shadow: var(--shadow);
}

.message-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
}

.message-stats {
    display: flex;
    gap: 20px;
}

.message-stats span {
    font-weight: 500;
    color: var(--dark);
}

.message-table {
    width: 100%;
    border-collapse: collapse;
}

.message-table th,
.message-table td {
    padding: 12px 15px;
    text-align: left;
    border-bottom: 1px solid #eee;
}

.message-table th {
    background-color: #f1f1f1;
    font-weight: 500;
}

.message-table tr:hover {
    background-color: #f9f9f9;
}

.message-actions {
    display: flex;
    gap: 10px;
}

/* æ“ä½œæ—¥å¿—æ ·å¼ */
.logs-container {
    background: white;
    border-radius: 12px;
    padding: 25px;
    margin-top: 30px;
    box-shadow: var(--shadow);
}

.log-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 15px;
    border-bottom: 1px solid #eee;
    transition: background-color 0.3s;
}

.log-item:hover {
    background-color: #f9f9f9;
}

.log-action {
    font-weight: 500;
    color: var(--primary);
}

.log-details {
    color: var(--gray);
    margin: 0 15px;
    flex: 1;
}

.log-time {
    color: var(--gray);
    font-size: 0.9rem;
}

/* æµé‡å›¾æ ·å¼ */
.traffic-chart {
    height: 200px;
    background: var(--light);
    border-radius: 8px;
    margin-top: 20px;
    display: flex;
    align-items: flex-end;
    gap: 5px;
    padding: 10px;
    box-sizing: border-box;
}

.traffic-bar {
    flex: 1;
    background: var(--primary);
    border-radius: 4px 4px 0 0;
    min-width: 20px;
    transition: height 0.5s;
}

/* å“åº”å¼è®¾è®¡ */
@media (max-width: 768px) {
    .navbar .container {
        flex-direction: column;
        gap: 15px;
    }
    
    .nav-links {
        flex-wrap: wrap;
        justify-content: center;
    }
    
    .admin-header {
        flex-direction: column;
        align-items: flex-start;
    }
    
    .admin-stats {
        grid-template-columns: 1fr 1fr;
    }
    
    .setting-row {
        flex-direction: column;
        align-items: flex-start;
    }
    
    .setting-row label {
        min-width: auto;
    }
    
    .setting-row select,
    .setting-row input {
        width: 100%;
    }
    
    .message-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 15px;
    }
    
    .log-item {
        flex-direction: column;
        align-items: flex-start;
        gap: 10px;
    }
    
    .log-details {
        margin: 5px 0;
    }
    
    .traffic-chart {
        height: 150px;
    }
}

/* çŠ¶æ€æ ‡ç­¾æ ·å¼ */
.status-tag-open {
    background-color: #d4edda;
    color: #155724;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 0.8rem;
    font-weight: 500;
}

.status-tag-limit {
    background-color: #fff3cd;
    color: #856404;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 0.8rem;
    font-weight: 500;
}

.status-tag-closed {
    background-color: #f8d7da;
    color: #721c24;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 0.8rem;
    font-weight: 500;
}

/* æ·»åŠ ç®¡ç†å‘˜è¡¨å• */
.add-admin-form {
    background: white;
    border-radius: 12px;
    padding: 20px;
    margin-top: 20px;
    box-shadow: var(--shadow);
}

.add-admin-form h4 {
    margin: 0 0 15px 0;
    color: var(--dark);
}

.form-row {
    display: flex;
    gap: 15px;
    margin-bottom: 15px;
    flex-wrap: wrap;
}

.form-row input {
    flex: 1;
    min-width: 200px;
    padding: 10px 15px;
    border: 1px solid #ddd;
    border-radius: 8px;
    font-size: 1rem;
}

.form-row button {
    padding: 10px 20px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-size: 1rem;
    font-weight: 500;
    transition: all 0.3s;
    background-color: var(--primary);
    color: white;
}

.form-row button:hover {
    background-color: #d32f2f;
}
    </style>
</head>
<body>
    <!-- å¯¼èˆªæ  -->
    <nav class="navbar">
        <div class="container">
            <div class="logo">
                <h2><i class="fas fa-user-shield"></i> ç®¡ç†å‘˜æ§åˆ¶å°</h2>
            </div>
            <div class="nav-links">
                <!-- ä¿®æ”¹ä¸º https://hjsf.uno -->
                <a href="https://hjsf.uno"><i class="fas fa-home"></i> è¿”å›é¦–é¡µ</a>
                <a href="#" id="logoutBtn"><i class="fas fa-sign-out-alt"></i> é€€å‡ºç™»å½•</a>
            </div>
        </div>
    </nav>

    <!-- ä¸»è¦å†…å®¹ -->
    <div class="container">
        <div class="page-header">
            <h1><i class="fas fa-user-shield"></i> ç®¡ç†å‘˜æ§åˆ¶å°</h1>
            <p>æ¬¢è¿ä½¿ç”¨çº¢å§ç§æˆ¿ç¾é£Ÿç½‘ç«™åå°ç®¡ç†ç³»ç»Ÿ</p>
        </div>

        <!-- ç™»å½•åŒºåŸŸ -->
        <div id="loginSection" class="login-container">
            <h2><i class="fas fa-sign-in-alt"></i> ç®¡ç†å‘˜ç™»å½•</h2>
            <form id="adminLogin">
                <div class="form-group">
                    <label for="username"><i class="fas fa-user"></i> ç”¨æˆ·å</label>
                    <input type="text" id="username" required>
                </div>
                <div class="form-group">
                    <label for="password"><i class="fas fa-lock"></i> å¯†ç </label>
                    <input type="password" id="password" required>
                </div>
                <button type="submit" class="btn"><i class="fas fa-sign-in-alt"></i> ç™»å½•</button>
            </form>
        </div>

        <!-- ç®¡ç†å‘˜é¢æ¿ (é»˜è®¤éšè—) -->
        <div id="adminPanel" class="admin-panel" style="display: none;">
            <div class="admin-header">
                <h2><i class="fas fa-tachometer-alt"></i> ä»ªè¡¨ç›˜</h2>
                <div class="admin-stats">
                    <div class="stat-card">
                        <div class="stat-label">æ€»è®¿é—®é‡</div>
                        <div class="stat-value" id="totalVisits">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">ä»Šæ—¥è®¿é—®</div>
                        <div class="stat-value" id="todayVisits">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">æ€»ç•™è¨€æ•°</div>
                        <div class="stat-value" id="totalMessagesHeader">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">æœªè¯»ç•™è¨€</div>
                        <div class="stat-value" id="unreadMessages">0</div>
                    </div>
                </div>
            </div>

            <!-- é¡µé¢çŠ¶æ€è®¾ç½® -->
            <div class="admin-settings">
                <div class="settings-section">
                    <h3><i class="fas fa-cogs"></i> é¡µé¢çŠ¶æ€ç®¡ç†</h3>
                    
                    <!-- ç‰¹äº§å•†åŸè®¾ç½® -->
                    <div class="page-setting">
                        <h4><i class="fas fa-shopping-bag"></i> ç‰¹äº§å•†åŸ</h4>
                        <div class="setting-row">
                            <label>çŠ¶æ€:</label>
                            <select id="productsStatus">
                                <option value="open">å¼€å¯</option>
                                <option value="limit">é™åˆ¶è®¿é—®</option>
                                <option value="closed">å…³é—­</option>
                            </select>
                            <!-- ä¼˜åŒ–1ï¼šè°ƒæ•´äº†è¾“å…¥æ¡†å®½åº¦ -->
                            <input type="number" id="productsDuration" placeholder="é™åˆ¶ç§’æ•°" min="1" style="width: 120px; display: none;">
                            <!-- æ–°å¢ï¼šå…³é—­å¯†ç è¾“å…¥æ¡† -->
                            <input type="text" id="productsPassword" placeholder="å…³é—­å¯†ç " style="width: 120px; display: none;">
                            <button class="btn" onclick="applyPageStatus('products')"><i class="fas fa-save"></i> åº”ç”¨</button>
                        </div>
                        <div class="current-status">å½“å‰çŠ¶æ€: <span id="productsCurrentStatus">æœªçŸ¥</span></div>
                    </div>

                    <!-- å…³äºæˆ‘ä»¬è®¾ç½® -->
                    <div class="page-setting">
                        <h4><i class="fas fa-info-circle"></i> å…³äºæˆ‘ä»¬</h4>
                        <div class="setting-row">
                            <label>çŠ¶æ€:</label>
                            <select id="aboutStatus">
                                <option value="open">å¼€å¯</option>
                                <option value="limit">é™åˆ¶è®¿é—®</option>
                                <option value="closed">å…³é—­</option>
                            </select>
                            <!-- ä¼˜åŒ–1ï¼šè°ƒæ•´äº†è¾“å…¥æ¡†å®½åº¦ -->
                            <input type="number" id="aboutDuration" placeholder="é™åˆ¶ç§’æ•°" min="1" style="width: 120px; display: none;">
                            <!-- æ–°å¢ï¼šå…³é—­å¯†ç è¾“å…¥æ¡† -->
                            <input type="text" id="aboutPassword" placeholder="å…³é—­å¯†ç " style="width: 120px; display: none;">
                            <button class="btn" onclick="applyPageStatus('about')"><i class="fas fa-save"></i> åº”ç”¨</button>
                        </div>
                        <div class="current-status">å½“å‰çŠ¶æ€: <span id="aboutCurrentStatus">æœªçŸ¥</span></div>
                    </div>

                    <!-- è”ç³»æ–¹å¼è®¾ç½® -->
                    <div class="page-setting">
                        <h4><i class="fas fa-phone"></i> è”ç³»æ–¹å¼</h4>
                        <div class="setting-row">
                            <label>çŠ¶æ€:</label>
                            <select id="contactStatus">
                                <option value="open">å¼€å¯</option>
                                <option value="limit">é™åˆ¶è®¿é—®</option>
                                <option value="closed">å…³é—­</option>
                            </select>
                            <!-- ä¼˜åŒ–1ï¼šè°ƒæ•´äº†è¾“å…¥æ¡†å®½åº¦ -->
                            <input type="number" id="contactDuration" placeholder="é™åˆ¶ç§’æ•°" min="1" style="width: 120px; display: none;">
                            <!-- æ–°å¢ï¼šå…³é—­å¯†ç è¾“å…¥æ¡† -->
                            <input type="text" id="contactPassword" placeholder="å…³é—­å¯†ç " style="width: 120px; display: none;">
                            <button class="btn" onclick="applyPageStatus('contact')"><i class="fas fa-save"></i> åº”ç”¨</button>
                        </div>
                        <div class="current-status">å½“å‰çŠ¶æ€: <span id="contactCurrentStatus">æœªçŸ¥</span></div>
                    </div>
                </div>

                <!-- ç®¡ç†å‘˜ç®¡ç† -->
                <div id="adminManagementSection" class="admin-settings">
                    <h3><i class="fas fa-users"></i> ç®¡ç†å‘˜ç®¡ç†</h3>
                    
                    <!-- åˆ›å»ºæ–°ç®¡ç†å‘˜ -->
                    <form id="addAdminForm" class="add-admin-form">
                        <h4>åˆ›å»ºæ–°ç®¡ç†å‘˜è´¦å·</h4>
                        <div class="form-row">
                            <input type="text" id="newAdminUsername" placeholder="è¾“å…¥æ–°ç®¡ç†å‘˜ç”¨æˆ·å" required>
                            <button type="submit" class="btn"><i class="fas fa-plus"></i> æ–°å¢</button>
                        </div>
                        <p style="font-size: 0.9rem; color: var(--gray); margin-top: 10px;"><i class="fas fa-info-circle"></i> æ–°è´¦å·é»˜è®¤å¯†ç ä¸º <strong>123456</strong>ï¼Œåˆ›å»ºåè¯·åŠæ—¶ä¿®æ”¹å¯†ç ã€‚</p>
                    </form>

                    <!-- ç®¡ç†å‘˜åˆ—è¡¨ -->
                    <div class="admin-list">
                        <h4 style="margin-top: 20px;">ç®¡ç†å‘˜åˆ—è¡¨</h4>
                        <table>
                            <thead>
                                <tr>
                                    <th>ç”¨æˆ·å</th>
                                    <!-- ä¼˜åŒ–2ï¼šæ–°å¢å¯†ç åˆ— -->
                                    <th>å¯†ç  (æ˜Ÿå·æ˜¾ç¤º)</th>
                                    <th>æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody id="adminListBody">
                                <!-- ç®¡ç†å‘˜åˆ—è¡¨å°†é€šè¿‡ JavaScript åŠ¨æ€åŠ è½½ -->
                            </tbody>
                        </table>
                    </div>

                    <!-- ä¿®æ”¹å½“å‰ç™»å½•ç®¡ç†å‘˜å¯†ç  -->
                    <div class="settings-section">
                        <h3><i class="fas fa-key"></i> ä¿®æ”¹å¯†ç </h3>
                        <form id="changePasswordForm" class="add-admin-form">
                            <div class="form-row">
                                <input type="password" id="oldPassword" placeholder="å½“å‰å¯†ç " required>
                                <input type="password" id="newPassword" placeholder="æ–°å¯†ç " required>
                                <button type="submit" class="btn"><i class="fas fa-sync"></i> ä¿®æ”¹</button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- ç•™è¨€ç®¡ç† -->
                <div class="messages-container">
                    <h3><i class="fas fa-comments"></i> ç•™è¨€ç®¡ç†</h3>
                    <div class="message-header">
                        <div class="message-stats">
                            <span>æ€»æ•°: <span id="totalMessages">0</span></span>
                            <span>æœªè¯»: <span id="unreadMessageCount">0</span></span>
                        </div>
                    </div>
                    <div id="messagesList">
                        <!-- ç•™è¨€å†…å®¹å°†é€šè¿‡JavaScriptåŠ¨æ€åŠ è½½ -->
                    </div>
                </div>

                <!-- è®¿é—®æ—¥å¿— -->
                <div class="logs-container">
                    <h3><i class="fas fa-history"></i> æ“ä½œæ—¥å¿—</h3>
                    <div id="logsList">
                        <!-- æ—¥å¿—å†…å®¹å°†é€šè¿‡JavaScriptåŠ¨æ€åŠ è½½ -->
                    </div>
                </div>

                <!-- æµé‡å›¾ -->
                <div class="logs-container">
                    <h3><i class="fas fa-chart-line"></i> è¿‘æœŸè®¿é—®æµé‡</h3>
                    <div class="traffic-chart" id="trafficChart">
                        <!-- æµé‡å›¾å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ä¿®æ”¹ç®¡ç†å‘˜å¯†ç çš„æ¨¡æ€æ¡† -->
    <div id="changeAdminPasswordModal" style="display:none; position: fixed; z-index: 1001; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.4); justify-content: center; align-items: center;">
        <div class="modal-content" style="background-color: white; margin: auto; padding: 20px; border-radius: 10px; width: 90%; max-width: 400px; box-shadow: 0 4px 8px rgba(0,0,0,0.2);">
            <span id="closeChangePasswordModal" style="float: right; cursor: pointer; font-size: 1.5rem;">&times;</span>
            <h3>ä¿®æ”¹ç®¡ç†å‘˜å¯†ç </h3>
            <p>ä¸ºç®¡ç†å‘˜ <strong><span id="changePasswordUsername"></span></strong> ä¿®æ”¹å¯†ç </p>
            <form id="changeSpecificAdminPasswordForm">
                <div class="form-group">
                    <label for="newAdminPassword">æ–°å¯†ç :</label>
                    <input type="password" id="newAdminPassword" class="form-control" required>
                </div>
                <button type="submit" class="btn"><i class="fas fa-sync"></i> ä¿®æ”¹å¯†ç </button>
                <button type="button" id="cancelChangePassword" class="btn btn-outline" style="margin-left: 10px;">å–æ¶ˆ</button>
            </form>
        </div>
    </div>

    <script>
// å…¨å±€å˜é‡
let isAdminLoggedIn = false;
let currentAdminUser = null; // è®°å½•å½“å‰ç™»å½•çš„ç®¡ç†å‘˜ç”¨æˆ·å
// ä¿®å¤ï¼šä½¿ç”¨ Base64 ç¼–ç å­˜å‚¨å¯†ç 
let adminAccounts = JSON.parse(localStorage.getItem('adminAccounts'))|| {'admin': btoa('hongjie123')}; // é»˜è®¤è´¦å· admin:hongjie123 (Base64)
let messages = JSON.parse(localStorage.getItem('messages'))|| [];
let logs = JSON.parse(localStorage.getItem('adminLogs'))|| [];
let visits = JSON.parse(localStorage.getItem('siteVisits'))|| { total: 0, daily: {} };

// é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', function() {
    console.log("ğŸ”§ é¡µé¢åŠ è½½å®Œæˆï¼Œå¼€å§‹åˆå§‹åŒ–...");
    
    // åˆå§‹åŒ–è®¾ç½®é¢æ¿ UI
    initializeSettingsPanel();
    
    console.log("âœ… é¡µé¢åŠ è½½å’Œé…ç½®åˆå§‹åŒ–å®Œæˆ");
});

// ç®¡ç†å‘˜ç™»å½•
document.getElementById('adminLogin').addEventListener('submit', function(e) {
    e.preventDefault(); // å…³é”®ï¼šç»å¯¹é˜»æ­¢è¡¨å•é»˜è®¤æäº¤å’Œé¡µé¢åˆ·æ–°
    
    const username = document.getElementById('username').value.trim();
    const password = document.getElementById('password').value;
    
    // - å…³é”®ä¿®æ”¹ï¼šä¼˜å…ˆä½¿ç”¨ä» OSS åŠ è½½çš„å…¨å±€ adminAccountsï¼Œå›é€€åˆ°å±€éƒ¨å˜é‡ -
    // è¿™ç¡®ä¿äº†æ–°è®¾å¤‡åœ¨åŠ è½½å®Œ OSS é…ç½®åï¼Œèƒ½ä½¿ç”¨å…¶ä¸­çš„è´¦å·ä¿¡æ¯è¿›è¡Œç™»å½•
    const accountsToUse = window.adminAccounts|| adminAccounts;
    
    console.log("ç™»å½•éªŒè¯æ—¶ä½¿ç”¨çš„è´¦å·åˆ—è¡¨ (accountsToUse):", accountsToUse); // è°ƒè¯•æ—¥å¿—ï¼Œå¯ä»¥æŸ¥çœ‹
    
    const storedHash = accountsToUse[username];
    
    // - ç»“æŸå…³é”®ä¿®æ”¹ -
    if(storedHash && storedHash === btoa(password)) { // ä½¿ç”¨ Base64 è§£ç æ¯”è¾ƒ
        isAdminLoggedIn = true;
        currentAdminUser = username; // è®°å½•å½“å‰ç”¨æˆ·
        
        document.getElementById('loginSection').style.display = 'none';
        document.getElementById('adminPanel').style.display = 'block';
        
        // è®°å½•ç™»å½•æ—¥å¿—
        addLog('ç®¡ç†å‘˜ç™»å½•', `ç®¡ç†å‘˜ ${username} ç™»å½•ç³»ç»Ÿ`);
        console.log(`ç®¡ç†å‘˜ ${username} ç™»å½•æˆåŠŸ`);
        alert(`æ¬¢è¿ï¼Œ${username}ï¼`);
        
        // - æ–°å¢ï¼šç™»å½•æˆåŠŸåï¼Œä» OSS åŠ è½½æœ€æ–°çš„é…ç½®å’Œæ•°æ®å¹¶æ›´æ–° UI -
        loadConfigFromOSSAndInitializeSettingsPanel().then(() => {
            console.log('âœ… ç™»å½•åæˆåŠŸä» OSS åŠ è½½é…ç½®å¹¶åˆå§‹åŒ– UI');
        }).catch((error) => {
            console.error('âŒ ç™»å½•åä» OSS åŠ è½½é…ç½®å¹¶åˆå§‹åŒ– UI å¤±è´¥:', error);
            // å³ä½¿åŠ è½½å¤±è´¥ï¼Œä¹Ÿä½¿ç”¨æœ¬åœ°é»˜è®¤å€¼åˆå§‹åŒ–
            // initializeSettingsPanel(); // initializeSettingsPanel å·²åœ¨ loadConfigFromOSSAndInitializeSettingsPanel å†…éƒ¨æˆ–å…¶å¤±è´¥å›è°ƒä¸­è¢«è°ƒç”¨
        });
    } else {
        alert('ç®¡ç†å‘˜è´¦å·æˆ–å¯†ç é”™è¯¯ï¼'); // ä¿æŒä¸€è‡´çš„æç¤º
        console.log(`ç®¡ç†å‘˜ ${username} ç™»å½•å¤±è´¥ï¼šè´¦å·æˆ–å¯†ç é”™è¯¯`);
        // å¯é€‰ï¼šæ‰“å°ä¸€ä¸‹å½“å‰ä½¿ç”¨çš„è´¦å·åˆ—è¡¨ï¼Œæ–¹ä¾¿è°ƒè¯•
        console.log("å½“å‰ç”¨äºéªŒè¯çš„è´¦å·åˆ—è¡¨ (accountsToUse):", accountsToUse);
    }
});

// é€€å‡ºç™»å½•
document.getElementById('logoutBtn').addEventListener('click', function() {
    isAdminLoggedIn = false;
    currentAdminUser = null; // æ¸…é™¤å½“å‰ç”¨æˆ·è®°å½•
    
    document.getElementById('loginSection').style.display = 'block';
    document.getElementById('adminPanel').style.display = 'none';
    
    // ä¿®å¤ï¼šé‡ç½®ç™»å½•è¡¨å•
    document.getElementById('adminLogin').reset(); // ä½¿ç”¨æ­£ç¡®çš„è¡¨å•ID
    
    addLog('é€€å‡ºç™»å½•', 'ç®¡ç†å‘˜é€€å‡ºäº†ç³»ç»Ÿ');
});

// åˆå§‹åŒ–è®¾ç½®é¢æ¿ UI
function initializeSettingsPanel() {
    console.log("ğŸ”§ å¼€å§‹åˆå§‹åŒ–è®¾ç½®é¢æ¿ UI...");
    
    // ä¿®å¤ï¼šä¼˜å…ˆä½¿ç”¨ä» OSS åŠ è½½çš„å…¨å±€é…ç½®
    const config = window.pageStatusConfig|| pageStatusConfig;
    const passwords = window.pagePasswords|| pagePasswords;
    
    // ä¿®å¤ï¼šä¼˜å…ˆä½¿ç”¨ä» OSS åŠ è½½çš„å…¨å±€ç®¡ç†å‘˜è´¦å·
    const accounts = window.adminAccounts|| adminAccounts;
    
    // åˆå§‹åŒ–é¡µé¢çŠ¶æ€è®¾ç½®
    Object.keys(config).forEach(pageId => {
        const pageConfig = config[pageId];
        const statusSelect = document.getElementById(`${pageId}Status`);
        const durationInput = document.getElementById(`${pageId}Duration`);
        const passwordInputForClosed = document.getElementById(`${pageId}Password`);
        
        if (statusSelect) {
            statusSelect.value = pageConfig.status || 'closed';
            
            if (pageConfig.duration) {
                durationInput.value = pageConfig.duration;
                durationInput.style.display = 'inline-block';
            } else {
                durationInput.style.display = 'none';
            }
            
            if (passwordInputForClosed) {
                passwordInputForClosed.value = passwords[pageId] || '';
                passwordInputForClosed.style.display = (pageConfig.status === 'closed') ? 'inline-block' : 'none';
            }
            
            updateCurrentStatusDisplay(pageId);
        }
    });
    
    // åˆå§‹åŒ–ç®¡ç†å‘˜åˆ—è¡¨
    if (document.getElementById('adminListBody')) {
        loadAdminList();
    }
    
    // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
    updateStats();
    loadMessages();
    loadLogs();
    drawTrafficChart();
    
    console.log("ğŸ”§ è®¾ç½®é¢æ¿ UI åˆå§‹åŒ–å®Œæˆ");
}

// åŠ è½½å¹¶æ˜¾ç¤ºç®¡ç†å‘˜åˆ—è¡¨ (åŒ…å«å¯†ç æ˜¾ç¤ºåŠŸèƒ½)
function loadAdminList() {
    const accounts = window.adminAccounts|| adminAccounts;
    const listBody = document.getElementById('adminListBody');
    
    if (!listBody) return;
    
    listBody.innerHTML = ''; // æ¸…ç©ºç°æœ‰åˆ—è¡¨
    
    Object.keys(accounts).forEach(username => {
        const row = document.createElement('tr');
        
        // åˆ›å»ºå¯†ç æ˜¾ç¤ºå•å…ƒæ ¼
        const passwordCell = document.createElement('td');
        passwordCell.className = 'password-cell';
        
        const passwordDisplay = document.createElement('span');
        passwordDisplay.className = 'password-display';
        passwordDisplay.textContent = 'â€¢â€¢â€¢â€¢â€¢â€¢';
        passwordDisplay.dataset.isMasked = 'true';
        
        const toggleButton = document.createElement('button');
        toggleButton.className = 'toggle-password-btn';
        toggleButton.innerHTML = '<i class="fas fa-eye"></i>';
        toggleButton.title = 'æ˜¾ç¤ºå¯†ç ';
        
        // æ·»åŠ å¯†ç æ˜¾ç¤ºåˆ‡æ¢åŠŸèƒ½
        toggleButton.addEventListener('click', function() {
            if (passwordDisplay.dataset.isMasked === 'true') {
                // å½“å‰æ˜¯éšè—ï¼Œç‚¹å‡»åæ˜¾ç¤ºæ˜æ–‡
                passwordDisplay.textContent = atob(accounts[username]); // Base64 è§£ç 
                passwordDisplay.dataset.isMasked = 'false';
                toggleButton.innerHTML = '<i class="fas fa-eye-slash"></i>';
                toggleButton.title = 'éšè—å¯†ç ';
            } else {
                // å½“å‰æ˜¯æ˜æ–‡ï¼Œç‚¹å‡»åæ˜¾ç¤ºæ˜Ÿå·
                passwordDisplay.textContent = 'â€¢â€¢â€¢â€¢â€¢â€¢';
                passwordDisplay.dataset.isMasked = 'true';
                toggleButton.innerHTML = '<i class="fas fa-eye"></i>';
                toggleButton.title = 'æ˜¾ç¤ºå¯†ç ';
            }
        });
        
        passwordCell.appendChild(passwordDisplay);
        passwordCell.appendChild(toggleButton);
        
        // åˆ›å»ºæ“ä½œå•å…ƒæ ¼
        const actionsCell = document.createElement('td');
        actionsCell.className = 'admin-actions';
        actionsCell.innerHTML = `
            <button class="action-btn" onclick="showChangePasswordModal('${username}')">
                <i class="fas fa-key"></i> ä¿®æ”¹å¯†ç 
            </button>
            ${username !== 'admin' ? 
                `<button class="action-btn delete-btn" onclick="deleteAdmin('${username}')">
                    <i class="fas fa-trash"></i> åˆ é™¤
                </button>` : 
                '<span style="color: var(--gray); font-size: 0.85rem;">(ä¸»è´¦å·)</span>'
            }
        `;
        
        // æ„å»ºè¡Œå†…å®¹
        row.innerHTML = `
            <td>${username}</td>
            <td></td> <!-- å ä½ï¼Œç¨åæ›¿æ¢ -->
            <td class="admin-actions"></td>
        `;
        
        // å°†å¯†ç å•å…ƒæ ¼æ’å…¥åˆ°æ­£ç¡®çš„ä½ç½®
        row.children[1].appendChild(passwordCell);
        // å°†æ“ä½œå•å…ƒæ ¼æ’å…¥åˆ°æ­£ç¡®çš„ä½ç½®
        row.children[2].innerHTML = actionsCell.innerHTML;
        
        listBody.appendChild(row);
    });
}

// æ˜¾ç¤ºä¿®æ”¹ç‰¹å®šç®¡ç†å‘˜å¯†ç çš„æ¨¡æ€æ¡†
let targetAdminForPasswordChange = null; // å…¨å±€å˜é‡ï¼Œè®°å½•è¦ä¿®æ”¹å¯†ç çš„ç®¡ç†å‘˜ç”¨æˆ·å

function showChangePasswordModal(username) {
    targetAdminForPasswordChange = username;
    document.getElementById('changePasswordUsername').textContent = username;
    document.getElementById('newAdminPassword').value = ''; // æ¸…ç©ºè¾“å…¥æ¡†
    document.getElementById('changeAdminPasswordModal').style.display = 'flex';
}

// å…³é—­æ¨¡æ€æ¡†
document.getElementById('closeChangePasswordModal').addEventListener('click', () => {
    document.getElementById('changeAdminPasswordModal').style.display = 'none';
});

document.getElementById('cancelChangePassword').addEventListener('click', () => {
    document.getElementById('changeAdminPasswordModal').style.display = 'none';
});

// ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨åŒºåŸŸå…³é—­
window.addEventListener('click', (event) => {
    const modal = document.getElementById('changeAdminPasswordModal');
    if (event.target === modal) {
        modal.style.display = 'none';
    }
});

// ä¿®æ”¹ç‰¹å®šç®¡ç†å‘˜å¯†ç 
document.getElementById('changeSpecificAdminPasswordForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    if (!isAdminLoggedIn|| !targetAdminForPasswordChange) return;
    
    const newPassword = document.getElementById('newAdminPassword').value.trim();
    
    if (!newPassword) {
        alert('è¯·è¾“å…¥æ–°å¯†ç ï¼');
        return;
    }
    
    // æ›´æ–°å†…å­˜ä¸­çš„å¯†ç 
    const accounts = window.adminAccounts|| adminAccounts;
    accounts[targetAdminForPasswordChange] = btoa(newPassword); // Base64 ç¼–ç 
    
    // åŒæ­¥åˆ° localStorage
    localStorage.setItem('adminAccounts', JSON.stringify(accounts));
    
    // åŒæ­¥åˆ°å…¨å±€å˜é‡ (å¦‚æœ window.adminAccounts å­˜åœ¨)
    if (window.adminAccounts) {
        window.adminAccounts = accounts;
    }
    
    // è®°å½•æ—¥å¿—
    addLog('ä¿®æ”¹ç®¡ç†å‘˜å¯†ç ', `ç®¡ç†å‘˜ ${currentAdminUser} ä¿®æ”¹äº† ${targetAdminForPasswordChange} çš„å¯†ç `);
    
    alert(`ç®¡ç†å‘˜ "${targetAdminForPasswordChange}" çš„å¯†ç å·²ä¿®æ”¹ï¼`);
    
    document.getElementById('changeAdminPasswordModal').style.display = 'none';
    
    // åŒæ­¥åˆ°äº‘ç«¯
    const configToSync = {
        pageStatusConfig: window.pageStatusConfig|| pageStatusConfig,
        pagePasswords: window.pagePasswords|| pagePasswords,
        adminAccounts: window.adminAccounts|| adminAccounts,
        messages: messages,
        adminLogs: logs,
        siteVisits: visits,
        timestamp: new Date().toISOString()
    };
    
    syncConfigToFC(configToSync).then(() => {
        console.log('Aliyun FC Sync: ä¿®æ”¹ç®¡ç†å‘˜å¯†ç åï¼Œé…ç½®å·²åŒæ­¥');
        loadAdminList(); // é‡æ–°åŠ è½½åˆ—è¡¨ä»¥åæ˜ å˜åŒ–
    }).catch((error) => {
        console.error('Aliyun FC Sync: ä¿®æ”¹ç®¡ç†å‘˜å¯†ç åï¼ŒåŒæ­¥é…ç½®å¤±è´¥:', error);
        addLog('ä¿®æ”¹ç®¡ç†å‘˜å¯†ç ', `ç®¡ç†å‘˜ ${currentAdminUser} ä¿®æ”¹äº† ${targetAdminForPasswordChange} çš„å¯†ç  (æœ¬åœ°ä¿®æ”¹æˆåŠŸï¼Œè¿œç¨‹åŒæ­¥åˆ°é˜¿é‡Œäº‘ FC å¤±è´¥: ${error.message})`);
        alert(`å¯†ç å·²ä¿®æ”¹(æœ¬åœ°)ï¼Œä½†åŒæ­¥åˆ°äº‘ç«¯æ—¶å‡ºé”™: ${error.message}`);
        loadAdminList(); // å³ä½¿åŒæ­¥å¤±è´¥ï¼Œä¹Ÿé‡æ–°åŠ è½½åˆ—è¡¨
    });
});

// åˆ é™¤ç®¡ç†å‘˜
function deleteAdmin(username) {
    if (!isAdminLoggedIn|| username === 'admin') return; // ç¦æ­¢åˆ é™¤ä¸»è´¦å·
    
    if (!confirm(`ç¡®å®šè¦åˆ é™¤ç®¡ç†å‘˜è´¦å· "${username}" å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚`)) {
        return;
    }
    
    // æ›´æ–°å†…å­˜ä¸­çš„è´¦å·åˆ—è¡¨
    const accounts = window.adminAccounts|| adminAccounts;
    delete accounts[username];
    
    // åŒæ­¥åˆ° localStorage
    localStorage.setItem('adminAccounts', JSON.stringify(accounts));
    
    // åŒæ­¥åˆ°å…¨å±€å˜é‡ (å¦‚æœ window.adminAccounts å­˜åœ¨)
    if (window.adminAccounts) {
        window.adminAccounts = accounts;
    }
    
    // è®°å½•æ—¥å¿—
    addLog('åˆ é™¤ç®¡ç†å‘˜', `ç®¡ç†å‘˜ ${currentAdminUser} åˆ é™¤äº†ç®¡ç†å‘˜è´¦å·: ${username}`);
    
    alert(`ç®¡ç†å‘˜è´¦å· "${username}" å·²åˆ é™¤ï¼`);
    
    // åŒæ­¥åˆ°äº‘ç«¯
    const configToSync = {
        pageStatusConfig: window.pageStatusConfig|| pageStatusConfig,
        pagePasswords: window.pagePasswords|| pagePasswords,
        adminAccounts: window.adminAccounts|| adminAccounts,
        messages: messages,
        adminLogs: logs,
        siteVisits: visits,
        timestamp: new Date().toISOString()
    };
    
    syncConfigToFC(configToSync).then(() => {
        console.log('Aliyun FC Sync: åˆ é™¤ç®¡ç†å‘˜åï¼Œé…ç½®å·²åŒæ­¥');
        loadAdminList(); // é‡æ–°åŠ è½½åˆ—è¡¨
    }).catch((error) => {
        console.error('Aliyun FC Sync: åˆ é™¤ç®¡ç†å‘˜åï¼ŒåŒæ­¥é…ç½®å¤±è´¥:', error);
        addLog('åˆ é™¤ç®¡ç†å‘˜', `ç®¡ç†å‘˜ ${currentAdminUser} åˆ é™¤äº†ç®¡ç†å‘˜è´¦å·: ${username} (æœ¬åœ°åˆ é™¤æˆåŠŸï¼Œè¿œç¨‹åŒæ­¥åˆ°é˜¿é‡Œäº‘ FC å¤±è´¥: ${error.message})`);
        alert(`è´¦å·å·²åˆ é™¤(æœ¬åœ°)ï¼Œä½†åŒæ­¥åˆ°äº‘ç«¯æ—¶å‡ºé”™: ${error.message}`);
        loadAdminList(); // å³ä½¿åŒæ­¥å¤±è´¥ï¼Œä¹Ÿé‡æ–°åŠ è½½åˆ—è¡¨
    });
}

// åˆ›å»ºæ–°ç®¡ç†å‘˜è´¦å·
document.getElementById('addAdminForm').addEventListener('submit', function(e) {
    e.preventDefault(); // é˜»æ­¢è¡¨å•é»˜è®¤æäº¤åˆ·æ–°é¡µé¢
    
    if (!isAdminLoggedIn) {
        alert('è¯·å…ˆç™»å½•ï¼');
        return;
    }
    
    // æ–°å¢ï¼šæƒé™æ£€æŸ¥
    if (currentAdminUser !== 'admin') {
        alert('åªæœ‰ä¸»ç®¡ç†å‘˜ (admin) å¯ä»¥åˆ›å»ºæ–°ç®¡ç†å‘˜è´¦å·ï¼');
        return;
    }
    
    const newUsername = document.getElementById('newAdminUsername').value.trim();
    
    if (!newUsername) {
        alert('è¯·è¾“å…¥æ–°ç®¡ç†å‘˜è´¦å·ï¼');
        return;
    }
    
    // ä¿®å¤ï¼šæ£€æŸ¥å…¨å±€å˜é‡ window.adminAccounts
    const currentAdminAccounts = window.adminAccounts|| adminAccounts;
    
    if (currentAdminAccounts[newUsername]) {
        alert('è¯¥ç®¡ç†å‘˜è´¦å·å·²å­˜åœ¨ï¼');
        return;
    }
    
    // æ·»åŠ æ–°è´¦å·ï¼Œé»˜è®¤å¯†ç  '123456'
    const defaultPassword = '123456';
    
    // ä¿®å¤ï¼šæ›´æ–°å…¨å±€å˜é‡å’Œ localStorage
    if (window.adminAccounts) {
        window.adminAccounts[newUsername] = btoa(defaultPassword); // æ›´æ–°å…¨å±€å˜é‡
    }
    adminAccounts[newUsername] = btoa(defaultPassword); // æ›´æ–°å±€éƒ¨å˜é‡ï¼ˆä¿é™©ï¼‰
    localStorage.setItem('adminAccounts', JSON.stringify(adminAccounts)); // ä¿å­˜åˆ° localStorage
    
    // è®°å½•æ—¥å¿—
    addLog('æ–°å¢ç®¡ç†å‘˜', `ç®¡ç†å‘˜ ${currentAdminUser} æ–°å¢äº†ç®¡ç†å‘˜è´¦å·: ${newUsername} (é»˜è®¤å¯†ç : ${defaultPassword})`);
    
    // å‡†å¤‡è¦åŒæ­¥åˆ°é˜¿é‡Œäº‘ FC çš„å®Œæ•´æ•°æ®ç»“æ„
    const configToSync = {
        pageStatusConfig: window.pageStatusConfig|| pageStatusConfig,
        pagePasswords: window.pagePasswords|| pagePasswords,
        adminAccounts: window.adminAccounts|| adminAccounts, // ä¼˜å…ˆä½¿ç”¨å…¨å±€ï¼ˆåŒ…å«æ–°è´¦å·ï¼‰
        messages: messages,
        adminLogs: logs,
        siteVisits: visits,
        timestamp: new Date().toISOString()
    };
    
    // è°ƒç”¨åŒæ­¥å‡½æ•°
    syncConfigToFC(configToSync).then(() => {
        console.log('Aliyun FC Sync: æ–°å¢ç®¡ç†å‘˜åï¼Œé…ç½®å·²åŒæ­¥');
        
        // æ¸…ç©ºè¡¨å•
        document.getElementById('addAdminForm').reset();
        
        alert(`ç®¡ç†å‘˜è´¦å· "${newUsername}" åˆ›å»ºæˆåŠŸå¹¶å·²åŒæ­¥ï¼é»˜è®¤å¯†ç ä¸º '${defaultPassword}'ï¼Œè¯·åŠæ—¶ä¿®æ”¹ã€‚`);
        
        // é‡æ–°åŠ è½½ç®¡ç†å‘˜åˆ—è¡¨
        loadAdminList();
    }).catch((error) => {
        console.error('Aliyun FC Sync: æ–°å¢ç®¡ç†å‘˜åï¼ŒåŒæ­¥é…ç½®å¤±è´¥:', error);
        
        // å³ä½¿åŒæ­¥å¤±è´¥ï¼Œæœ¬åœ°è®¾ç½®å·²ç”Ÿæ•ˆï¼Œå¯ä»¥æç¤ºç”¨æˆ·
        addLog('æ–°å¢ç®¡ç†å‘˜', `ç®¡ç†å‘˜ ${currentAdminUser} æ–°å¢äº†ç®¡ç†å‘˜è´¦å·: ${newUsername} (æœ¬åœ°æ·»åŠ æˆåŠŸï¼Œè¿œç¨‹åŒæ­¥åˆ°é˜¿é‡Œäº‘ FC å¤±è´¥: ${error.message})`);
        
        // æ¸…ç©ºè¡¨å•
        document.getElementById('addAdminForm').reset();
        
        alert(`ç®¡ç†å‘˜è´¦å· "${newUsername}" å·²åˆ›å»º(æœ¬åœ°)ï¼Œä½†åŒæ­¥åˆ°äº‘ç«¯æ—¶å‡ºé”™: ${error.message}ã€‚è¯·ç¨åæ‰‹åŠ¨åŒæ­¥æˆ–æ£€æŸ¥ç½‘ç»œã€‚`);
        
        // å³ä½¿åŒæ­¥å¤±è´¥ï¼Œä¹Ÿé‡æ–°åŠ è½½ç®¡ç†å‘˜åˆ—è¡¨
        loadAdminList();
    });
});

// ä¿®æ”¹å¯†ç 
document.getElementById('changePasswordForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    if (!isAdminLoggedIn) {
        alert('è¯·å…ˆç™»å½•ï¼');
        return;
    }
    
    const oldPasswordInput = document.getElementById('oldPassword');
    const newPasswordInput = document.getElementById('newPassword');
    
    const oldPassword = oldPasswordInput.value;
    const newPassword = newPasswordInput.value;
    
    if (!oldPassword || !newPassword) {
        alert('è¯·è¾“å…¥æ—§å¯†ç å’Œæ–°å¯†ç ï¼');
        return;
    }
    
    // éªŒè¯æ—§å¯†ç 
    const accounts = window.adminAccounts|| adminAccounts;
    
    if (accounts[currentAdminUser] !== btoa(oldPassword)) {
        alert('æ—§å¯†ç é”™è¯¯ï¼');
        return;
    }
    
    // æ›´æ–°å¯†ç 
    accounts[currentAdminUser] = btoa(newPassword);
    
    // åŒæ­¥åˆ° localStorage
    localStorage.setItem('adminAccounts', JSON.stringify(accounts));
    
    // åŒæ­¥åˆ°å…¨å±€å˜é‡ (å¦‚æœ window.adminAccounts å­˜åœ¨)
    if (window.adminAccounts) {
        window.adminAccounts = accounts;
    }
    
    // è®°å½•æ—¥å¿—
    addLog('ä¿®æ”¹å¯†ç ', `ç®¡ç†å‘˜ ${currentAdminUser} ä¿®æ”¹äº†è‡ªå·±çš„å¯†ç `);
    
    // æ¸…ç©ºè¡¨å•
    oldPasswordInput.value = '';
    newPasswordInput.value = '';
    
    alert('å¯†ç ä¿®æ”¹æˆåŠŸï¼');
    
    // ä¿®æ”¹å¯†ç åä¹ŸåŒæ­¥æ‰€æœ‰é…ç½®
    const configToSync = {
        pageStatusConfig: window.pageStatusConfig|| pageStatusConfig,
        pagePasswords: window.pagePasswords|| pagePasswords,
        adminAccounts: window.adminAccounts|| adminAccounts,
        messages: messages,
        adminLogs: logs,
        siteVisits: visits,
        timestamp: new Date().toISOString()
    };
    
    syncConfigToFC(configToSync).then(() => {
        console.log('Aliyun FC Sync: ä¿®æ”¹å¯†ç åï¼Œé…ç½®å·²åŒæ­¥');
    }).catch((error) => {
        console.error('Aliyun FC Sync: ä¿®æ”¹å¯†ç åï¼ŒåŒæ­¥é…ç½®å¤±è´¥:', error);
        addLog('ä¿®æ”¹å¯†ç ', `ç®¡ç†å‘˜ ${currentAdminUser} ä¿®æ”¹äº†è‡ªå·±çš„å¯†ç  (æœ¬åœ°ä¿®æ”¹æˆåŠŸï¼Œè¿œç¨‹åŒæ­¥åˆ°é˜¿é‡Œäº‘ FC å¤±è´¥: ${error.message})`);
        alert(`å¯†ç å·²ä¿®æ”¹(æœ¬åœ°)ï¼Œä½†åŒæ­¥åˆ°äº‘ç«¯æ—¶å‡ºé”™: ${error.message}`);
    });
});

// åº”ç”¨é¡µé¢çŠ¶æ€è®¾ç½®
function applyPageStatus(pageId) {
    const statusSelect = document.getElementById(`${pageId}Status`);
    const durationInput = document.getElementById(`${pageId}Duration`);
    const passwordInputForClosed = document.getElementById(`${pageId}Password`);
    const password = passwordInputForClosed?.value|| '';
    
    if (!statusSelect) return;
    
    const status = statusSelect.value;
    const duration = status === 'limit' ? parseInt(durationInput?.value)|| 10 : null;
    
    // æ›´æ–°å†…å­˜ä¸­çš„é…ç½®
    // ä¿®å¤ï¼šä¼˜å…ˆä½¿ç”¨ä» OSS åŠ è½½çš„å…¨å±€é…ç½®
    const config = window.pageStatusConfig|| pageStatusConfig;
    const passwords = window.pagePasswords|| pagePasswords;
    
    config[pageId] = config[pageId]|| {};
    config[pageId].status = status;
    
    if (duration !== null) {
        config[pageId].duration = duration;
    } else {
        delete config[pageId].duration;
    }
    
    // å§‹ç»ˆæ›´æ–°å¯†ç 
    passwords[pageId] = password;
    
    // æ›´æ–°UIæ˜¾ç¤º
    updateCurrentStatusDisplay(pageId);
    
    if (durationInput) {
        durationInput.style.display = (status === 'limit') ? 'inline-block' : 'none';
    }
    
    if(passwordInputForClosed) {
        passwordInputForClosed.style.display = (status === 'closed') ? 'inline-block' : 'none';
    }
    
    // è®°å½•æ—¥å¿—
    addLog('ä¿®æ”¹é¡µé¢çŠ¶æ€', `å°†é¡µé¢ "${pageId}" çš„çŠ¶æ€ä¿®æ”¹ä¸º: ${status}${duration ? ` (${duration}ç§’)` : ''}${password ? ' (å·²è®¾ç½®å¯†ç )' : ''}`);
    
    // å‡†å¤‡è¦åŒæ­¥åˆ°é˜¿é‡Œäº‘ FC çš„å®Œæ•´æ•°æ®ç»“æ„
    const configToSync = {
        pageStatusConfig: window.pageStatusConfig|| pageStatusConfig,
        pagePasswords: window.pagePasswords|| pagePasswords,
        adminAccounts: window.adminAccounts|| adminAccounts,
        messages: messages,
        adminLogs: logs,
        siteVisits: visits,
        timestamp: new Date().toISOString()
    };
    
    // è°ƒç”¨åŒæ­¥å‡½æ•°
    syncConfigToFC(configToSync).then(() => {
        console.log('Aliyun FC Sync: é¡µé¢çŠ¶æ€ä¿®æ”¹åï¼Œé…ç½®å·²åŒæ­¥');
    }).catch((error) => {
        console.error('Aliyun FC Sync: é¡µé¢çŠ¶æ€ä¿®æ”¹åï¼ŒåŒæ­¥é…ç½®å¤±è´¥:', error);
        addLog('ä¿®æ”¹é¡µé¢çŠ¶æ€', `å°†é¡µé¢ "${pageId}" çš„çŠ¶æ€ä¿®æ”¹ä¸º: ${status}${duration ? ` (${duration}ç§’)` : ''}${password ? ' (å·²è®¾ç½®å¯†ç )' : ''} (æœ¬åœ°ä¿®æ”¹æˆåŠŸï¼Œè¿œç¨‹åŒæ­¥åˆ°é˜¿é‡Œäº‘ FC å¤±è´¥: ${error.message})`);
    });
}

// æ›´æ–°å½“å‰çŠ¶æ€æ˜¾ç¤º
function updateCurrentStatusDisplay(pageId) {
    // ä¿®å¤ï¼šä¼˜å…ˆä½¿ç”¨ä» OSS åŠ è½½çš„å…¨å±€é…ç½®
    const config = window.pageStatusConfig|| pageStatusConfig;
    const status = config[pageId]?.status|| 'closed';
    const duration = config[pageId]?.duration;
    const currentStatusTextElement = document.getElementById(`${pageId}CurrentStatus`);
    let statusText = '';
    let statusClass = '';
    
    switch(status) {
        case 'open':
            statusText = 'å¼€å¯';
            statusClass = 'status-tag-open';
            break;
        case 'limit':
            statusText = `é™åˆ¶ (${duration|| 10}ç§’)`;
            statusClass = 'status-tag-limit';
            break;
        case 'closed':
            statusText = 'å…³é—­';
            statusClass = 'status-tag-closed';
            break;
        default:
            statusText = 'æœªçŸ¥';
            statusClass = 'status-tag-default';
    }
    
    if (currentStatusTextElement) {
        currentStatusTextElement.textContent = statusText;
        currentStatusTextElement.className = statusClass;
    }
}

// æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
function updateStats() {
    document.getElementById('totalVisits').textContent = visits.total|| 0;
    document.getElementById('totalMessagesHeader').textContent = messages.length|| 0;
    
    const unreadCount = messages.filter(msg => !msg.read).length;
    document.getElementById('unreadMessages').textContent = unreadCount;
    document.getElementById('totalMessages').textContent = messages.length|| 0;
    document.getElementById('unreadMessageCount').textContent = unreadCount;
}

// åŠ è½½ç•™è¨€
function loadMessages() {
    const messagesList = document.getElementById('messagesList');
    if (!messagesList) return;
    
    // æ¸…ç©ºç°æœ‰ç•™è¨€
    messagesList.innerHTML = '';
    
    // åå‘æ’åºï¼ˆæœ€æ–°çš„åœ¨å‰é¢ï¼‰
    const sortedMessages = [...messages].reverse();
    
    sortedMessages.forEach((msg, index) => {
        const row = document.createElement('div');
        row.className = 'message-row';
        row.innerHTML = `
            <div class="message-content">
                <div class="message-header">
                    <strong>${msg.name}</strong>
                    <span>${msg.timestamp}</span>
                </div>
                <div class="message-body">
                    <p>${msg.message}</p>
                </div>
                <div class="message-footer">
                    <small>ç”µè¯: ${msg.phone}</small>
                </div>
            </div>
            <div class="message-actions">
                <button class="action-btn delete-btn" data-index="${messages.length - 1 - index}">
                    <i class="fas fa-trash"></i>
                </button>
                <button class="action-btn export-btn" data-index="${messages.length - 1 - index}">
                    <i class="fas fa-download"></i>
                </button>
            </div>
        `;
        
        messagesList.appendChild(row);
        
        // æ·»åŠ åˆ é™¤åŠŸèƒ½
        row.querySelector('.delete-btn').addEventListener('click', function() {
            const index = messages.length - 1 - parseInt(this.getAttribute('data-index'));
            if(confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡ç•™è¨€å—ï¼Ÿ')) {
                // è®°å½•åˆ é™¤æ—¥å¿—
                addLog('åˆ é™¤ç•™è¨€', `ç®¡ç†å‘˜ ${currentAdminUser} åˆ é™¤äº† ${messages[index].name} çš„ç•™è¨€`);
                messages.splice(index, 1);
                localStorage.setItem('messages', JSON.stringify(messages));
                loadMessages(); // é‡æ–°åŠ è½½
            }
        });
        
        // æ·»åŠ å¯¼å‡ºåŠŸèƒ½
        row.querySelector('.export-btn').addEventListener('click', function() {
            const index = messages.length - 1 - parseInt(this.getAttribute('data-index'));
            const message = messages[index];
            const content = `å§“å: ${message.name}\nç”µè¯: ${message.phone}\nç•™è¨€: ${message.message}\næ—¶é—´: ${message.timestamp}`;
            const blob = new Blob([content], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `ç•™è¨€-${message.name}-${message.timestamp}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        });
    });
}

// åŠ è½½æ“ä½œæ—¥å¿—
function loadLogs() {
    const logsList = document.getElementById('logsList');
    if (!logsList) return;
    
    // æ¸…ç©ºç°æœ‰æ—¥å¿—
    logsList.innerHTML = '';
    
    // åå‘æ’åºï¼ˆæœ€æ–°çš„åœ¨å‰é¢ï¼‰
    [ ...logs ].reverse().forEach(log => {
        const logItem = document.createElement('div');
        logItem.className = 'log-item';
        logItem.innerHTML = `
            <div>
                <span class="log-action">${log.action}</span>
                <span class="log-details">${log.details}</span>
            </div>
            <div class="log-time">${log.timestamp}</div>
        `;
        logsList.appendChild(logItem);
    });
}

// ç»˜åˆ¶æµé‡å›¾
function drawTrafficChart() {
    const chartContainer = document.getElementById('trafficChart');
    if (!chartContainer) return;
    
    // è·å–æœ€è¿‘7å¤©çš„æ•°æ®
    const dates = [];
    const values = [];
    
    for (let i = 6; i >= 0; i--) {
        const date = new Date();
        date.setDate(date.getDate() - i);
        const dateStr = date.toLocaleDateString();
        dates.push(dateStr);
        
        const value = visits.daily[dateStr] || 0;
        values.push(value);
    }
    
    // æ¸…ç©ºå›¾è¡¨å®¹å™¨
    chartContainer.innerHTML = '';
    
    // è®¡ç®—æœ€å¤§å€¼ç”¨äºæ¯”ä¾‹ç¼©æ”¾
    const maxValue = Math.max(...values, 1);
    
    // ç»˜åˆ¶æŸ±çŠ¶å›¾
    values.forEach((value, index) => {
        const bar = document.createElement('div');
        bar.className = 'traffic-bar';
        bar.style.height = `${(value / maxValue) * 100}%`;
        bar.title = `${dates[index]}: ${value} æ¬¡è®¿é—®`;
        chartContainer.appendChild(bar);
    });
}

// æ·»åŠ æ“ä½œæ—¥å¿—
function addLog(action, details) {
    const timestamp = new Date().toLocaleString();
    logs.push({ action, details, timestamp });
    
    // åªä¿ç•™æœ€è¿‘100æ¡æ—¥å¿—
    if (logs.length > 100) {
        logs.shift();
    }
    
    localStorage.setItem('adminLogs', JSON.stringify(logs));
    loadLogs(); // æ›´æ–°æ—¥å¿—æ˜¾ç¤º
}

// åŒæ­¥é…ç½®åˆ°é˜¿é‡Œäº‘ FC
async function syncConfigToFC(config) {
    try {
        const response = await fetch('https://updatewteconfig-aquxgazwhl.cn-hangzhou.fcapp.run/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(config)
        });
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        return await response.json();
    } catch (error) {
        console.error('åŒæ­¥é…ç½®åˆ°é˜¿é‡Œäº‘ FC å¤±è´¥:', error);
        throw error;
    }
}

// ä»é˜¿é‡Œäº‘ OSS åŠ è½½é…ç½®å¹¶åˆå§‹åŒ–è®¾ç½®é¢æ¿
async function loadConfigFromOSSAndInitializeSettingsPanel() {
    try {
        const response = await fetch('https://xiao-config-bucket.oss-cn-hangzhou.aliyuncs.com/test-config.json');
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        
        if (data && data.pageStatusConfig) {
            console.log("âœ… æˆåŠŸä» OSS è¯»å–åˆ°é…ç½®:", data);
            
            // æ›´æ–°å…¨å±€é…ç½®å˜é‡å’Œå¯†ç å˜é‡ä»¥åŠç®¡ç†å‘˜è´¦å·å˜é‡
            window.pageStatusConfig = data.pageStatusConfig;
            window.pagePasswords = data.pagePasswords|| {};
            window.adminAccounts = data.adminAccounts|| {}; // æ–°å¢ï¼šæ›´æ–°å…¨å±€ç®¡ç†å‘˜è´¦å·å˜é‡
            window.messages = data.messages|| []; // æ–°å¢ï¼šæ›´æ–°å…¨å±€ç•™è¨€å˜é‡
            window.logs = data.adminLogs|| []; // æ–°å¢ï¼šæ›´æ–°å…¨å±€æ—¥å¿—å˜é‡
            window.visits = data.siteVisits|| { total: 0, daily: {} }; // æ–°å¢ï¼šæ›´æ–°å…¨å±€è®¿é—®é‡å˜é‡
            
            console.log("ğŸ”„ å·²æ›´æ–°å…¨å±€é…ç½®å˜é‡");
            
            // åˆå§‹åŒ–è®¾ç½®é¢æ¿ UI
            initializeSettingsPanel();
        } else {
            console.log("OSS: è¿œç¨‹é…ç½®ä¸ºç©ºæˆ–æ ¼å¼ä¸æ­£ç¡®");
            // å›é€€åˆ° localStorage
            initializeSettingsPanel();
        }
    } catch (fetchError) {
        console.error("âŒ ä»é˜¿é‡Œäº‘ OSS åŠ è½½é…ç½®å¤±è´¥:", fetchError);
        // å›é€€åˆ° localStorage
        initializeSettingsPanel();
    }
}
    </script>
</body>
</html>
